\documentclass[12pt,a4paper]{book}
\usepackage[latin1]{inputenc}    % Ascii-Format dieses Dokuments
\usepackage{longtable}           % lange Tabellen
\usepackage{makeidx}             % indexing
\makeindex

\begin{document}
\title{EOF\\Eris Onion Forwarding\\
The secure, peer-to-peer, decentralised
anonymous chat network\thanks{Version 0.6}}
%\date{...}
\author{Nico -telmich- Schottelius}

\maketitle
\tableofcontents
%\newpage

% -----------------------------------------------------------------------------
\chapter{Introduction}
% ----------------------------------------------------------------------------
\section{Copying}
Copy it as you like - send corrections to me.
% Nico: 1.0
% FIXME: Free, see creative commons!
% -----------------------------------------------------------------------------
\section{Abstract}
EOF is a chat protocol that supports secure chatting.
Secure chatting consists of the following features:
\begin{enumerate}
\item Nobody, but the intended receiver(s) know(s) \emph{that} you wrote a message.
\item Nobody, but the intended receiver(s) can view the \emph{message content}.
\item Nobody, but the intended receiver(s) can \emph{verify} the source of the message being you.
\item Nobody, but the intended receiver(s) know(s) \emph{who} you sent a message to.
\item The network must survive attacks of a single attacker.
\item Hard (if not practilcally impossible) to block chatting.
\end{enumerate}
Additionally, for practical reasons, EOF must support the following
chat features:
\begin{enumerate}
\item Direct chat ("`message is only seen by one person"')
\item Group chat ("`message is sent to specific group, which may consist of
more than one person"')
\end{enumerate}
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Hide message sending}
We don't think it's possible to hide that you are part of the chat network,
because some heuristics will be developed to detect the chat packets.
So we use a different idea:
Every participant of an EOF network will constantly send chat packets
with a pre-defined frequency (for instance every 250 ms).
If you don't chat, \emph{noise} is sent.\footnote{Noise is just random
data, see below for a more detailled description of noise.}
The noise is also used to defend against timing analysis.
In case you are sending out a message, the message packet will be added to the
queue and sent within the next free time slot.

From outside it can easily be seen, that you are part of the network,
but not, if you sent a message.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Hide message content}
We encrypt every message via public-key cryptography\cite{pgp-1},
so that only the receiver can decrypt and view the message content.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Verify sender}
Before the encrypt the packet, it is signed via public-key
cryptography\cite{pgp-1}. Thus only the receiver can verify the message sender.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Hide message receiver}
The message packets are always sent indirectly via onion routing\cite{onion-1}.
The idea is taken from the Tor project\cite{tor-1}, though EOF uses an enhanced
version: EOF does not know about entry or exit nodes. If you are the intended
receiver you may or may not continue to forward the message, which is defined
by the sender of the message. That said, EOF must use source
routing\cite{source-routing-1}.

To support onion routing, the sender of a packet needs to encrypt the packet
multiple times, once for each host that receives the packet. This may look
as follows:
\begin{enumerate}
\item Create message (from noise or user input)
\item Create source path
\item Create packet for last peer ("`pkg-last"')
\item Create packet for last-1 peer including \emph{pkg-last}
\item Continue until first peer is reached
\item Sent packet to first peer
\end{enumerate}
Thus every peer only knows the previous and the next peer.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Reliable against single user attacks}
Traditional chat networks depend on one or more central organised servers.
An attacker can stop all communication, if she runs a successful denial
of service ("`DoS"') attack against the central systems.
To protect against this, EOF uses a dynamic peer-to-peer network, which works
as long as the minimun number of peers and the destination peer is available.
It has no dependency on a central server.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Hide packets in network stream}
As said before, we don't think it's possible to hide the participation in the
chat network. To be able to send packets, although an attacker \emph{knows}
about the participation, EOF embeds all chat packets into other (well known)
protocols (which is knows as steganography\cite{stegano-1}).
EOF does not implement nor specify \emph{transport protocols} itself.
The EOF community is urged to implement them in a creative way: Usage
of well-known protocols like TCP\cite{tcp-1}, HTTP\cite{http-1},
SMTP\cite{smtp-1} or even transmission of packets on avian
carriers\cite{avian-1} are encouraged. The tunneling of EOF packets through
those protocols (also know as obfuscation) makes it harder to detect
and \emph{block} EOF traffic.
If an attacker wants you to stop sending messages, she has to completly
remove you from the network, because any open protocol may be (ab)used to
encapsulate EOF packets into it.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Real world usability}
To be able to be compete with other chat protocols, EOF needs
to support \emph{direct} and \emph{group chat}, which is
implemented by two different chat destinations:
\begin{enumerate}
\item \emph{Peers}
\item \emph{Groups of peers}
\end{enumerate}
A peer is just another person (direct chat), a group of peers is the EOF
equivalent of the IRC channel\cite{irc-1}. As there is no central server,
groups of peers are managed by each client, and thus the compositions of
group members may be different on different peers.
% Nico: 1.0
% -----------------------------------------------------------------------------
\section{Motivation}
% -----------------------------------------------------------------------------
\subsection{Current implementations are not secure}
There are already many different chat protocols available like
\begin{itemize}
\item talk
\item IRC
\item SILC
\item Jabber
\item ICQ
\item Skype
\end{itemize}
Only two of those protocols contains mandority encryption (SILC, Skype), which
still lacks many features for secure chatting.\footnote{Most of them can be
enhanced to use TLS/SSL, but this is not enforced.} Skype and SILC still
depend on a central server architecture. The Skype architecture is not
publicly documentated, the executing binary is encrypted, and the system
depends on a single company, which excluded it from being a secure chat
system.

Because SILC depends on a central server architecture, it was also excluded.
% Nico: 1.0
% FIXME: add references for protocols!
% -----------------------------------------------------------------------------
\subsection{Create more crypto traffic}
We also want to convey usage of PGP: currently PGP is quite seldom.
Thus if you use PGP, you may be conspicuous. We try to make PGP encrypted
packets part of the regular internet traffic, like webtraffic is today.
% Nico: 1.0
% FIXME: add references for PGP
% -----------------------------------------------------------------------------
\section{The project}
The project started in 2007 as an idea of !eof\cite{!eof}
(a friendly hacker community). After several meetings it was clear that
we need to do some experiements and create phases to structure the
development.
% -----------------------------------------------------------------------------
\subsection{The three phases}
So we divided the project into the three phases
\begin{enumerate}
\item \emph{EOF-1},
\item \emph{EOF-2},
\item \emph{EOF-3}.
\end{enumerate}
% -----------------------------------------------------------------------------
\subsubsection{EOF-1: Finding ideas}
The first phase was the so called "`finding ideas"' phase. We did some tests,
measured packet sizes and did some theorethic calculations on intervals.
There was also some discussion about implementing EOF in a ring structure,
like token ring\cite{token-ring}.
The first try to do the first implementation as a complet modularised
version began and stalled after some months of decentral developemnt.
% FIXME: cite
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsubsection{EOF-2: Proof of concept}
We are currently working on a prototype in EOF-2. The idea is to get the
basic features working and to attract testers and developers.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsubsection{EOF-3: The final destination}
The idea of EOf-3 is to cleanup all parts of EOF-2 and create a
"`ready to be used"' software package, that may be used by end users.
This includes "`good documentation"' (this document).
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Further directions}
After the deployment of EOF-3, there may be more work necessary, like
\begin{itemize}
\item Deep analysis of security (by us and foreigners),
\item enhance performance,
\item port to other systems,
\item adapt to changed environment,
\item \ldots{}
\end{itemize}
% Nico: 1.0
% -----------------------------------------------------------------------------
\section{Conventions}
% -----------------------------------------------------------------------------
\subsection{Writing convention}
There are not many things to take care about, when reading this document:
\begin{itemize}
\item \emph{\$NAME} is used to mark an environment variable.
\item Parameters enclosed in $<$ and $>$ must be specified to the command.
\item Parameters enclosed in $<$ and $...>$ must be specified at least one,
but may be repeated. This is only valid for the last parameter.
\item Parameters enclosed in $[$ and $]$ can be specified optionally.
\item \emph{EOF\_L\_\textit{NAME}} is used to specify a certain length
\end{itemize}
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Abbreviations}
As some terms are quite often used, we created some abbreviations:
\index{abbreviations}%
\index{EOF (abreviation)}%
\index{EOFi (abreviation)}%
\index{rEOFi (abreviation)}%
\index{EOFs (abreviation)}%
\index{FLS (abreviation)}%
\begin{longtable}{|c|c|}
\caption{List of abbreviations}\\
\hline
\textbf{Abbreviation} & \textbf{Meaning}\\
\hline
EOF & Eris onion forwarding, name of this project\\
\hline
EOFi & An EOF implementation\\
\hline
rEOFi & The reference EOF implementation (also called "`ceofhack"')\\
\hline
EOFs & An EOF subsystem\\
\hline
EOFsdt & EOF simple data type\\
\hline
FLS & Fixed length string\\
\hline
\end{longtable}
% Nico: 1.0
% -----------------------------------------------------------------------------
\chapter{The EOF standard}
This section defines the complete EOF standard. All required operations,
features, protocol specifications, paths, interfaces and environment definition,
etc. are described.
% Nico: 1.0
% -----------------------------------------------------------------------------
\section{Introduction}
% -----------------------------------------------------------------------------
\subsection{Version}
As soon as this standard is usable and the first version of \emph{rEOFi}
is released, it will version number \textbf{01} of the standard.
Further changes will be documented in this section. All version numbers
are two ASCII digits (see below).
% Nico: FIXME for 1.0
% -----------------------------------------------------------------------------
\subsection{Modular setup}
As there are many parts needed to realise such a chat system, the EOF
standard defines a modular setup to be used:
\begin{itemize}
\item EOFi is the central EOFi implementation
\item EOFi is the central connection point for all other EOFs 
\end{itemize}
This modular design allows different developers to code each EOFs
in a different way (and probably different programming language).
A complete implementation consists of at least:
\begin{itemize}
\item EOFi - central communication daemon
\item UI - at least one user interface
\item TP - at least one transport protocol
\end{itemize}
% -----------------------------------------------------------------------------
\section{Interface description ("`eofi2any"')}
This section defines which interfaces EOFi offers to communicate with
subsystems in general. Each subsystem may use a subset or the full set
of interfaces, which is defined in their respective sections.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Stdin, stdout and stderr (via pipes)}
EOFi is capable of executing a program and connecting its STDIN, STDOUT and
STDERR to EOFi. The rEOFi uses pipes, but other EOFis may use different
methods.\footnote{See pipe(2) and forkexecpipe() in rEOFi.}
The three filehandles are used as follows:
\begin{longtable}{|c|c|}
\caption{Stdin, stdout, stderr}\\
\hline
\textbf{Name} & \textbf{Used for}\\
\hline
stdin & Commands sent from EOFi\\
\hline
stdout & Commands sent from EOFs\\
\hline
stderr & Diagnostic messages sent from EOFs\\
\hline
\end{longtable}
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Unix Sockets}
Unix sockets are provided by EOFi to allow external applications to
connect to EOFi.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Environment variables}
The following environment variable are either used or set by EOFi and are
available for all EOFs.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsubsection{\$HOME}
The home directory of the user. It is required by EOFi to locate the
configuration directory.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsubsection{\$EOF\_HOME}
The EOFi configuration directory. If set by before EOFi starts, it will
skip the autodetection of the configuration directory.
This variable is exported to all EOFs.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsubsection{\$EOF\_UI\_SOCKET}
This variable contains the absolute path to the socket, which should be used
by user interfaces (UIs).
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Asynchronous bidirectional communication}
Every connection between any EOFs and EOFi is asynchronous (both sides
can start sending on their own) and bidirectional (both sides can send
at the same time.

Thus every EOFs and EOFi have to implement one (or more) queues to
keep the state of their packet.

To identify an answer to a packet, each packet contains an
identification number, which is chosen by the sender
(for more information have a look at section \ref{idn} on
page \pageref{idn}).
% Nico: 1.0
% -----------------------------------------------------------------------------
\section{Paths}
% -----------------------------------------------------------------------------
\subsection{EOFi configuration directory}
% -----------------------------------------------------------------------------
\subsubsection{Default case}
Normally, \$HOME is set and \$EOF\_HOME is not set. In that case
the configuration directory defaults to \textit{\$HOME/.ceof}.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsubsection{\$HOME is unset}
If the environment variable "`\textit{\$HOME}`" is not set,
the directory named \textit{.ceof} in the current directory will be used.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsubsection{\$EOF\_HOME is set}
If the environment variable "`\textit{\$EOF\_DIR}`" is set,
its content will be used to refer to the configuration directory.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{User interface (unix socket)}
\label{ui-socket}
If the environment variable \textit{\$EOF\_UI\_SOCKET} is set, the user
interface should connect to this unix socket. Otherwise it should connect
to the socket "`ui/socket"' below the EOFi configuration directory
(see above for rules how to locate that).
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Crypto engine}
\label{crypto-key}
The directory "'\textbf{crypto}"' below the EOFi configuration directory contains
all crypto related files. The file "'\textbf{mykeyid}"' contains the
keyid used for signing messages.
% -----------------------------------------------------------------------------
\section{Configuration}
The configuration of EOFi is stored in the cconfig\cite{cconfig} format.
% Nico: FIXME for 1.0: cite
% -----------------------------------------------------------------------------
\section{Basic data types ("`EOFbdt"')}
This section specifies the basic datatypes used in EOF.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{The zero byte}
The zero byte is a byte with the value 0.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Line feed}
The line feed, "`\textbackslash{}n"', was used to terminate data
sections, but is \emph{DEPRECATED} now.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{ASCII numbers}
ASCII numbers use the decimal string representation of a number (versus
binary representation, which is \emph{never} used between EOFi and EOFs).
ASCII numbers are often used in a packet header.
ASCII numbers are used to specify the length of the packet (excluding itself).
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Strings in general}
Strings are transmitted without termination (i.e. no new line, no 0 byte),
but are padded with zero bytes, if shorter than the specified length.
The encoding to be used is always \textbf{UTF-8}\cite{utf8}.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Fixed length strings}
Fixed length strings contain exactly the specified number of bytes:
A 128-byte fixed length string consists of at most 128 bytes of text,
which is then not zero terminated!
If the text it contains is shorter than the specified length,
it must be padded with zero bytes.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Variable length strings}
The EOF protocol currently does not specify any variable length strings.
All strings are fixed length (see above).
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Noise}
There are many situations in which an EOFi sends out data to the network,
although you did not write a message: In fact, as EOFi \textbf{always}
sends packets in a fixed interval, it needs to have data to encrypt and send.

Noise can be any type of random data. As the current random number generators
are quite expensive, it is recommend to use a huge dictionary, old
messages, logfiles, public emails, etc. for noise input.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Unused}
To make life harder for attackers we try to make packets always be more or
less the same size. That results in fields being present in a packet, which
are unsued.

Unused fields should be filled up with noise.
% Nico: 1.0
% #############################################################################
\section{EOF simple data types ("`EOFsdt"')}
The following sections define the datatypes used in EOF related
applications. The recommened name for use in source
code is added in parentheses after the human understandable name.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{EOF commands and command fields (mapping table)}
An EOF command is exactly \emph{EOF\_L\_CMD} bytes long (fixed length string)
and contains an ASCII number.

EOF commands are the main method of communication between EOFs and EOFi.

The command field 0 indicates the direction.
The command field 1 indicates the EOF subsystem.
\begin{longtable}{|c|c|c|}
\caption{Command fields}\\
\hline
\textbf{Value} & \textbf{Subsystem} / \textbf{Description} & \textbf{Ref}\\
\hline
1*** & Message is coming from the EOF implementation &\\
\hline
10** & \textbf{eofi2tp}: Transport protocols & p\pageref{eofi2tp}\\
\hline
11** & \textbf{eofi2ui}: User interface & p\pageref{eofi2ui}\\
\hline
12** & \textbf{eofi2crypto}: Crypto engine & p\pageref{eofi2crypto}\\
\hline
13** & \textbf{eofi2noise}: Noise generator & p\pageref{eofi2noise}\\
\hline
2*** & Message is coming from EOF subsystem (internally) &\\
\hline
20** & \textbf{eofi2tp}: Transport protocols & p\pageref{eofi2tp}\\
\hline
21** & \textbf{eofi2ui}: User interface & p\pageref{eofi2ui}\\
\hline
22** & \textbf{eofi2crypto}: Crypto engine & p\pageref{eofi2crypto}\\
\hline
23** & \textbf{eofi2noise}: Noise generator & p\pageref{eofi2noise}\\
\hline
3*** & Message is coming from outside ("`onion packet"')) &\\
\hline
\end{longtable}
The command fields 2 and 3 are defined by the respective subsystem.
% -----------------------------------------------------------------------------
\subsection{Identification string (id)}
\label{idn}
To identify a packet, each packet contains an identification string,
which is \emph{EOF\_L\_ID} bytes long. It may contain only the
following characters:
\begin{itemize}
\item A-Z (alphabet in upper case)
\item a-z (alphabet in lower case)
\item 0-9 (the digits)
\item ! (exclamation mark)
\item - (minus)
\end{itemize}
The EOFs or EOFi may chose freely any of the \emph{68719476736}
possibilities.\footnote{$(26+26+10+2)^6$, as long as EOF\_L\_ID is 6.}
The characters are limited to those characters to allow easy debugging
and to keep the non-binary command layout.
% -----------------------------------------------------------------------------
\subsection{Size (size)}
\index{eof.h (File)}%
All sizes used in this document are "`symbolic sizes"': The real size
is defined in the attached file "`\emph{eof.h}"'.
Developers are advised to use the symbolic name in their programs.

A size is is always represented as an ASCII number found in a
fixed length string of \emph{EOF\_L\_SIZE} bytes.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Nick name (nick)}
The peer name is a \emph{EOF\_L\_NICKNAME} byte fixed length string.
It is only used internally to give a peer a rememberable name ("`a nick'").
It is never transmitted over the network.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Group name (group)}
The group name is a \emph{EOF\_L\_GROUP} byte fixed length string.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Message text (msgtext)}
The message text is a \emph{EOF\_L\_MESSAGE} byte fixed length string.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Peer address (addr)}
The address of a peer, which is is a \emph{EOF\_L\_ADDRESS}
byte fixed length string. Peer addresses are specified as
URLs as defined in RFC3986\cite{uri-1}. For more information have
a look at section \ref{tp} on page \pageref{tp}.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Keyid, the fingerprint (keyid)}
A (PGP) fingerprint\footnote{See RFC 2440, 11.2. Key IDs and Fingerprints}
is a \emph{EOF\_L\_KEYID} byte fixed length string.
It does not contain any spaces.
It can be retrieved by issuing the following gpg-command:
\begin{verbatim}
LC_ALL=C gpg --fingerprint  | \
   grep "Key fingerprint =" | \
   sed -e 's/.*=//' -e 's/ //g' 
\end{verbatim}
% Nico: 1.0
% #############################################################################
\section{EOF packets ("`EOFpkg"')}
\label{eofpkg}
% -----------------------------------------------------------------------------
\subsection{Introduction}
No packet (including everything) may exceed the size of \emph{EOF\_L\_PKG\_MAX}.

EOF knows about
\begin{itemize}
\item commands: internal plaintext packets.
\item onions: multiple times encrypted packets including routing information
\item postcards: packets containing transport protocol dependent header
\end{itemize}
Commands are the innermost packet type and only seen within EOFi and EOFs.
Commands are then bundled into a multi layer onion. Each layer contains
commands after decryption.
Onions are put onto a postcard afterwards and are sent out on the network.
\textbf{Only encrypted packets are sent out on the network.}
% -----------------------------------------------------------------------------
\subsection{Commands}
Command packets are used for the communication inside of EOFi and EOFs and
are described in detail in the following sections:
\begin{itemize}
\item eofi2tp, \ref{eofi2tp}, page \pageref{eofi2tp}
\item eofi2ui, \ref{eofi2ui}, page \pageref{eofi2ui}
\item eofi2crypto, \ref{eofi2crypto}, page \pageref{eofi2crypto}
\end{itemize}
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Onions}
Onions are sent out on the network and are multiple times encrypted.
They are building the base for the EOF protocol.
Onions are described in detail in chapter \ref{onions}, page \pageref{onions}.
% -----------------------------------------------------------------------------
\subsection{Postcards}
Onions are afterwards encapsulated into the transport protocol specific
packet type and sent out onto the network.
Postcards are described in detail in chapter \ref{postcards}, page \pageref{postcards}.
% -----------------------------------------------------------------------------
% #############################################################################
\section{Transport protocols ("`eofi2tp"')}
\label{eofi2tp}
% -----------------------------------------------------------------------------
\subsection{Introduction}
URLs are used as defined in RFC3986\cite{uri-1}.
% -----------------------------------------------------------------------------
\subsection{1000: Send packet}
\index{Command!1000}
\begin{longtable}{|c|c|c|c|}
\caption{Command 1000 parameters}\\
\hline
\textbf{Parameter} & \textbf{Type} & \textbf{Description} & \textbf{Example}\\
\hline
ID & EOFsdt: id & packet id & afdb12\\
\hline
Destination & EOFsdt: addr & complete URL (with "`\emph{scheme:}"') & tcp:127.0.0.3:42\\
\hline
Size & EOFsdt: size & Size of message, excluding this header & 424242\\
\hline
Message & Binary data & The message & BLOB\\
\hline
\end{longtable}
\subsubsection{Possible answers}
\begin{itemize}
\item 2000
\item 2001
\end{itemize}
% -----------------------------------------------------------------------------
\subsubsection{1000: Example}
Added linebreak after some \textbackslash{}0 for readability, which are \textbf{not} in
the real packet!
\begin{verbatim}
1000abfudh127.0.0.3:42\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0
\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0
\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0
\0\0\0\0\0\0\0\0\0\010\0\0\0\0HEREISDATA
\end{verbatim}
% -----------------------------------------------------------------------------
\subsection{1001: Enable listening}
\index{Command!1001}%
When the listening transport protocol starts up, EOFi sends this command and
waits for the acknowledge package, before it marks the listening
transport protocol as enabled.
\begin{longtable}{|c|c|c|c|}
\caption{Command 1001 parameters}\\
\hline
\textbf{Parameter} & \textbf{Type} & \textbf{Description} & \textbf{Example}\\
\hline
ID & EOFsdt: id & packet id & afdb12\\
\hline
Destination & EOFsdt: addr & URL without "`\emph{scheme:}"' & 127.0.0.3:42\\
\hline
\end{longtable}
\subsubsection{Possible answers}
\begin{itemize}
\item 2003
\end{itemize}
% -----------------------------------------------------------------------------
\subsubsection{1001: Example}
\begin{verbatim}
1001afdb12127.0.0.3:42\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0
\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0
\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0
\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0
\end{verbatim}
% -----------------------------------------------------------------------------
\subsection{1002: Stop listening}
\index{Command!1002}%
This command requests a listening transport protocol to 
shutdown. It should free all ressources and exit.
After a grace time (maybe seconds, not yet defined), EOFi will kill the badly
behaving transport protocol.
\begin{longtable}{|c|c|c|c|}
\caption{Command 1001 parameters}\\
\hline
\textbf{Parameter} & \textbf{Type} & \textbf{Description} & \textbf{Example}\\
\hline
ID & EOFsdt: id & packet id & afdb12\\
\hline
\end{longtable}
\subsubsection{Possible answers}
\begin{itemize}
\item none
\end{itemize}
% -----------------------------------------------------------------------------
\subsubsection{1002: Example}
\begin{verbatim}
1002
\end{verbatim}
% -----------------------------------------------------------------------------
\subsection{2000: Packet successfully sent}
This code is returned by the transport protocol subsystem to EOFi on success.
After this return code, the transport protocol exits.
\begin{longtable}{|c|c|c|c|}
\caption{Command 2000 parameters}\\
\hline
\textbf{Parameter} & \textbf{Type} & \textbf{Description} & \textbf{Example}\\
\hline
ID & EOFsdt: id & packet id & afdb12\\
\hline
\end{longtable}
% -----------------------------------------------------------------------------
\subsection{2001: Packet not sent}
\index{Command!2001}
This code is returned by the transport protocol subsystem to the
EOF implementation on failure.
After this return code, the transport protocol exits.
\begin{longtable}{|c|c|c|c|}
\caption{Command 2001 parameters}\\
\hline
\textbf{Parameter} & \textbf{Type} & \textbf{Description} & \textbf{Example}\\
\hline
ID & EOFsdt: id & packet id & afdb12\\
\hline
\end{longtable}
% -----------------------------------------------------------------------------
\subsection{2002: Received packet}
\index{Command!2002}
The listening transport protocol received a packet and notifies EOFi.
\begin{longtable}{|c|c|c|c|}
\caption{Command 2002 parameters}\\
\hline
\textbf{Parameter} & \textbf{Type} & \textbf{Description} & \textbf{Example}\\
\hline
ID & EOFsdt: id & packet id & afdb12\\
\hline
Size & EOFsdt:size & Excluding the 2002 and this field & 42\\
\hline
Message & Binary data & The message & BLOB\\
\hline
\end{longtable}
% -----------------------------------------------------------------------------
\subsection{2003: Listening}
\index{Command!2003}
This code is returned by the listening transport protocol, as soon as the
listening process is ready to receive data. After that, EOFi can announce
the listening URL to other EOFi.
\begin{longtable}{|c|c|c|c|}
\caption{Command 2003 parameters}\\
\hline
\textbf{Parameter} & \textbf{Type} & \textbf{Description} & \textbf{Example}\\
\hline
ID & EOFsdt: id & packet id & afdb12\\
\hline
\end{longtable}
% -----------------------------------------------------------------------------
\subsection{2004: Not listening}
\index{Command!2004}
If something happended that makes the listening transport protocol
unable to startup, it issues this command and exits afterwards.
\begin{longtable}{|c|c|c|c|}
\caption{Command 2004 parameters}\\
\hline
\textbf{Parameter} & \textbf{Type} & \textbf{Description} & \textbf{Example}\\
\hline
ID & EOFsdt: id & packet id & afdb12\\
\hline
\end{longtable}
% #############################################################################
\section{The user interface ("`ui2user"')}
This section specifies the appereance of a user interface to the user.
% Nico: 1.0
%---------------------------------------------------------------------
\subsection{Minimal philosophy}
All EOF compliant user interfaces must support the named commands, so the
user can change the UI, but can be sure that this minimal amount of
commands is always available.

Every user interface \emph{may} add additional input methods or commands.
% Nico: 1.0
%---------------------------------------------------------------------
\subsection{Commands in general}
All commands begin with a "`/"' as first character (adopted from IRC).
% Nico: 1.0
%---------------------------------------------------------------------
\subsection{Command length}
The user interfaces need only to accept commands up to a length of
\emph{EOF\_L\_UI\_INPUT}.
If the user inputs longer commands, they should be truncated
to \emph{EOF\_L\_UI\_INPUT} bytes.
% Nico: 1.0
%---------------------------------------------------------------------
\subsection{Send text}
If the entered text does not begin with a "`/"', it should be treated
as a message to the current selected destination (either
a \emph{peer} or \emph{group} of peers.
% Nico: 1.0
%---------------------------------------------------------------------
\subsection{/peer add $<$nick$>$ $<$initial addr$>$ $<$keyid$>$}
Add the peer as \textit{name} to the list of known peers.

\index{Command!/peer add}%
\begin{longtable}{|c|c|c|c|}
\caption{/peer add parameters}\\
\hline
\textbf{Parameter} & \textbf{Type} & \textbf{Description} & \textbf{Example}\\
\hline
Nick & EOFsdt & Name you identify the peer with & telmich\\
\hline
Initial addr & EOFsdt & Where we can make the first contact & tcp:10.0.42.42:4242\\
\hline
Keyid & EOFsdt & The PGP fingerprint of the peers public key & F27987E34E66...\\
\hline
\end{longtable}

\subsubsection{Example}
\begin{verbatim}
/peer add telmich tcp:10.0.42.42:4242 F27987E34E7866B2BA39C2FD793EB8FC325251FE
\end{verbatim}
% Nico: 1.0
%---------------------------------------------------------------------
\subsection{/peer send $<$nick$>$ $<$msgtext...$>$}
Send message \textit{msgtext} to peer \textit{nick}.

\index{Command!/peer send}%
\begin{longtable}{|c|c|c|c|}
\caption{/peer send parameters}\\
\hline
\textbf{Parameter} & \textbf{Type} & \textbf{Description} & \textbf{Example}\\
\hline
Nick & EOFsdt & Name you identify the peer with & telmich\\
\hline
Msgtext & EOFsdt & The message itself & Hallo, wie geht es Dir?\\
\hline
\end{longtable}

\subsubsection{Example}
\begin{verbatim}
/peer send telmich Hallo, wie geht es Dir?
\end{verbatim}
% Nico: 1.0
%---------------------------------------------------------------------
\subsection{/peer rename $<$oldnick$>$ $<$newnick$>$}
Renames the peer.
\index{Command!/peer rename}%
\begin{longtable}{|c|c|c|c|}
\caption{/peer rename parameters}\\
\hline
\textbf{Parameter} & \textbf{Type} & \textbf{Description} & \textbf{Example}\\
\hline
Oldnick & EOFsdt & Old nick name & susi\\
\hline
Newnick & EOFsdt & New nick name & heinz\\
\hline
\end{longtable}

\subsubsection{Example}
\begin{verbatim}
/peer rename susi heinz
\end{verbatim}
% Nico: 1.0
%---------------------------------------------------------------------
\subsection{/peer show $<$nick$>$}
Display detailled information about peer.
\index{Command!/peer show}%
\begin{longtable}{|c|c|c|c|}
\caption{/peer rename parameters}\\
\hline
\textbf{Parameter} & \textbf{Type} & \textbf{Description} & \textbf{Example}\\
\hline
Nick name & EOFsdt & Nick name as known by EOFi & karl-otto\\
\hline
\end{longtable}

\subsubsection{Example}
\begin{verbatim}
/peer show karl-otto
\end{verbatim}
% Nico: 1.0
%---------------------------------------------------------------------
\subsection{/peer list}
List currently known peers. This command does not accept any parameters.

\subsubsection{Example}
\begin{verbatim}
/peer list
\end{verbatim}
% Nico: 1.0
%---------------------------------------------------------------------
\subsection{/exit}
Request the user interface to exit. It will deregister from EOFi,
but EOFi will continue to run (even with no user interface attached).
\subsubsection{Example}
\begin{verbatim}
/exit
\end{verbatim}
% Nico: 1.0
%---------------------------------------------------------------------
\subsection{/quit}
The UI tells EOFi to quit.
The EOFi will tell all EOFs to quit and quits.
Afterwards the UI will also quit.
\subsubsection{Example}
\begin{verbatim}
/quit
\end{verbatim}
% Nico: 1.0
%---------------------------------------------------------------------
\subsection{Aliases}
Aliases may optionally be provided by the UI. If an UI provides
support for aliases, it must implement the "`\emph{/alias}"' command.

The following aliases should be provided by default,
to aid new users using EOF.
% Nico: 1.0
%---------------------------------------------------------------------
\subsection{/alias $<aliasname>$ $<command...>$}
This command should be used to setup aliases.
% Nico: 1.0
%---------------------------------------------------------------------
\subsection{/msg $<nick>$ $<msgtext>$}
Should be an alias for \textit{/peer send $<$nick$>$ $<$msgtext$>$}
% Nico: 1.0
%---------------------------------------------------------------------
\subsection{/whois $<nick>$}
Should be an alias for \textit{/peer show $<$nick$>$}
% Nico: 1.0

% #############################################################################

\section{Interface to the user interface ("`eofi2ui"')}
\label{eofi2ui}
This section specifies the commands used between the EOFs
"`user interface"' and EOFi. As the user interface has to translate
the user commands ("`ui2user"') to \emph{eofi2ui} commands, the
section titles refer to the \emph{ui2user} and \emph{eofi2ui} commands.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{UI startup}
What todo, when the UI starts.
Connect to EOFi. Find out about
\begin{itemize}
\item joined group,
\item connected marktscheier
\item and open queries.
\end{itemize}
It thus issues the following commands:
register, list joined groups, list open queries, list marktschreier.
% -----------------------------------------------------------------------------
\subsection{Connection}
All user interfaces connect to the user interface socket, as specified
on page \pageref{ui-socket}, section \ref{ui-socket}.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{1100: Acknowledge}
The is a general acknowledge answer. The request with the
same \emph{ID} as the packet was successful.
\subsubsection{Parameters}
\begin{longtable}{|c|c|c|c|}
\caption{Command 1100 parameters}\\
\hline
\textbf{Parameter} & \textbf{Type} & \textbf{Description} & \textbf{Example}\\
\hline
ID & EOFsdt: id & packet id & afdb12\\
\hline
\end{longtable}
\subsubsection{Example}
\begin{verbatim}
1100abfudh
\end{verbatim}
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{1101: Failure}
The is a general failure answer. The request with the
same \emph{ID} as the packet failed.
Details are specified in the reason message.
\subsubsection{Parameters}
\begin{longtable}{|c|c|c|c|}
\caption{Command 1101 parameters}\\
\hline
\textbf{Parameter} & \textbf{Type} & \textbf{Description} & \textbf{Example}\\
\hline
ID & EOFsdt: id & packet id & afdb12\\
\hline
Reason & EOFsdt: msgtxt & Why the connection was refused & Too many UIs connected.\\
\hline
\end{longtable}
If the failed command was "`2100"', EOFi will close the socket afterwards.
\subsubsection{Example}
\begin{verbatim}
1101abfudhSome error\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0
\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0
\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0
\0\0\0\0\0\0\0\0\0
\end{verbatim}
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{1102: Exit requested}
This is a  shutdown request to the UI.
After this message EOFi will exit and there is no communication possible.
\subsubsection{Parameters}
\begin{longtable}{|c|c|c|c|}
\caption{Command 1102 parameters}\\
\hline
\textbf{Parameter} & \textbf{Type} & \textbf{Description} & \textbf{Example}\\
\hline
ID & EOFsdt: id & packet id & afdb12\\
\hline
\end{longtable}
\subsubsection{Example}
\begin{verbatim}
1102abf93a
\end{verbatim}
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{1103: Recieved message}
This message is issued by EOFi, if a message is received.
\subsubsection{Parameters}
\index{Command!1103}
\begin{longtable}{|c|c|c|c|}
\caption{Command 1103 parameters}\\
\hline
\textbf{Parameter} & \textbf{Type} & \textbf{Description} & \textbf{Example}\\
\hline
ID & EOFsdt: id & packet id & afdb12\\
\hline
nick & EOFsdt & The sender & telmich\\
\hline
msgtext & EOFsdt & The message & Hallo, mein Freund!\\
\hline
\end{longtable}
\subsubsection{Example}
\begin{verbatim}
1103abfudhtelmich\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0
\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0
\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0
\0\0\0\0\0\0\0\0\0\0Hallo!\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0
\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0
\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0
\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0
\end{verbatim}
\subsubsection{Possible answers}
\begin{itemize}
\item None: EOFi does not resend this packet if the UI lost it.
\end{itemize}
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{1104: List of peers}
This is the answer to command \emph{2106} and thus contains the
same ID, as the \emph{2106} request command.
\subsubsection{Parameters}
\begin{longtable}{|c|c|c|c|}
\caption{Command 1104 parameters}\\
\hline
\textbf{Parameter} & \textbf{Type} & \textbf{Description} & \textbf{Example}\\
\hline
ID & EOFsdt: id & packet id & afdb12\\
\hline
Number of peers (nop) & EOFsdt: size & How many peers follow & 20\\
\hline
$nop * Peer$ & EOFsdt: nick & The nickname & telmich\\
\hline
\end{longtable}
The last field is repeated as many times as specified in number of peers.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{1105: Peer information}
This is the answer to command \emph{2105} and thus contains the
same ID, as the \emph{2105} request command.
\subsubsection{Parameters}
\begin{longtable}{|c|c|c|c|}
\caption{Command 1105 parameters}\\
\hline
\textbf{Parameter} & \textbf{Type} & \textbf{Description} & \textbf{Example}\\
\hline
ID & EOFsdt: id & packet id & afdb12\\
\hline
Keyid & EOFsdt:keyid & This peers pgp-keyid & 389E5481065EAA253...\\
\hline
Number of addresses (noa) & EOFsdt: size & & 1\\
\hline
$noa * address$ & EOFsdt: addr & Adress of peer & tcp:127.0.0.1:4243\\
\hline
\end{longtable}
The last field is repeated as often, as specified in the number of addresses
field.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{1106: Peer renamed}
This is the answer to command \emph{2104} and thus contains the
same ID, as the \emph{2104} request command. It is sent out to
\textbf{all} connected user interfaces.
\subsubsection{Parameters}
\begin{longtable}{|c|c|c|c|}
\caption{Command 1106 parameters}\\
\hline
\textbf{Parameter} & \textbf{Type} & \textbf{Description} & \textbf{Example}\\
\hline
ID & EOFsdt: id & packet id & afdb12\\
\hline
Oldnick & EOFsdt & Old nick name & susi\\
\hline
Newnick & EOFsdt & New nick name & heinz\\
\hline
\end{longtable}
\subsubsection{Possible answers}
\begin{itemize}
\item None
\end{itemize}
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{2100: Register user interface}
This must be the \emph{first} message sent by the UI. If the answer is not
\emph{1100}, the UI should close the socket afterwards.

\subsubsection{Parameters}
\begin{longtable}{|c|c|c|c|}
\caption{Command 2100 parameters}\\
\hline
\textbf{Parameter} & \textbf{Type} & \textbf{Description} & \textbf{Example}\\
\hline
ID & EOFsdt: id & packet id & afdb12\\
\hline
\end{longtable}

\subsubsection{Possible answers}
\begin{itemize}
\item 1100
\item 1101
\end{itemize}
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{2101: Deregister user interface}

\subsubsection{Parameters}
\begin{itemize}
\item none
\end{itemize}

\subsubsection{Possible answers}
\begin{itemize}
\item none
\end{itemize}

EOFi will close the connection to the UI after receiving this message.

% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{2102: /peer add}
The UI adds a peer to the list of known peers.

\subsubsection{Parameters}
\index{Command!2102: /peer add}%
\begin{longtable}{|c|c|c|c|}
\caption{2102: /peer add parameters}\\
\hline
\textbf{Parameter} & \textbf{Type} & \textbf{Description} & \textbf{Example}\\
\hline
ID & EOFsdt: id & packet id & afdb12\\
\hline
Nick & EOFsdt: nick & Name you identify the peer with & telmich\\
\hline
Address & EOFsdt: addr & Where we can make the first contact & tcp:10.0.42.42:4242\\
\hline
Keyid & EOFsdt: keyid & PGP fingerprint of the peers key & F27987E34E66...\\
\hline
\end{longtable}

\subsubsection{Possible answers}
\begin{itemize}
\item 1100
\item 1101
\end{itemize}
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{2103: /peer send}
The UI wants to submit a message to a peer.

\subsubsection{Parameters}
\index{Command!/peer send}%
\begin{longtable}{|c|c|c|c|}
\caption{2103: /peer send parameters}\\
\hline
\textbf{Parameter} & \textbf{Type} & \textbf{Description} & \textbf{Example}\\
\hline
ID & EOFsdt: id & packet id & afdb12\\
\hline
Nick & EOFsdt: nick & Name you identify the peer with & telmich\\
\hline
Message & EOFsdt: msgtxt & The message itself & Hallo, wie geht es Dir?\\
\hline
\end{longtable}

\subsubsection{Possible answers}
\begin{itemize}
\item 1100
\item 1101
\end{itemize}
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{2104: /peer rename}
The UI wants to rename a peer.

\subsubsection{Parameters}
\index{Command!/peer rename}%
\begin{longtable}{|c|c|c|c|}
\caption{/peer rename parameters}\\
\hline
\textbf{Parameter} & \textbf{Type} & \textbf{Description} & \textbf{Example}\\
\hline
ID & EOFsdt: id & packet id & afdb12\\
\hline
Oldnick & EOFsdt & Old nick name & susi\\
\hline
Newnick & EOFsdt & New nick name & heinz\\
\hline
\end{longtable}

\subsubsection{Possible answers}
\begin{itemize}
\item 1106
\item 1101
\end{itemize}

% -----------------------------------------------------------------------------
\subsection{2105: /peer show}
The UI requests details about a peer.

\subsubsection{Parameters}
\begin{longtable}{|c|c|c|c|}
\caption{2105: /peer show parameters}\\
\hline
\textbf{Parameter} & \textbf{Type} & \textbf{Description} & \textbf{Example}\\
\hline
ID & EOFsdt: id & packet id & afdb12\\
\hline
Nick name & EOFsdt & Nick name, as known by EOFi & karl-otto\\
\hline
\end{longtable}

\subsubsection{Possible answers}
\begin{itemize}
\item 1101
\item 1105
\end{itemize}
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{2106: /peer list}
The UI requests the list of known peers.

\subsubsection{Parameters}
\begin{longtable}{|c|c|c|c|}
\caption{2106: /peer list parameters}\\
\hline
\textbf{Parameter} & \textbf{Type} & \textbf{Description} & \textbf{Example}\\
\hline
ID & EOFsdt: id & packet id & afdb12\\
\hline
\end{longtable}

\subsubsection{Possible answers}
\begin{itemize}
\item 1101
\item 1104
\end{itemize}
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{2199: /quit}
The user interface requests EOFi and all other EOFs to exit.
The EOFi will not answer, but send an exit request to all other
EOFs.

\subsubsection{Parameters}
\begin{longtable}{|c|c|c|c|}
\caption{2199: /quit parameters}\\
\hline
\textbf{Parameter} & \textbf{Type} & \textbf{Description} & \textbf{Example}\\
\hline
ID & EOFsdt: id & packet id & afdb12\\
\hline
\end{longtable}

\subsubsection{Possible answers}
\begin{itemize}
\item none
\end{itemize}
% Nico: 1.0
% #############################################################################
\section{Interface to the encryption engine ("`eofi2crypto"')}
\label{eofi2crypto}
% -----------------------------------------------------------------------------
\subsection{Connection}
The crypto engine is started by EOFi at startup and communicates with EOFi
through stdin and stdout. It also gets the path to the gpg-homedir as the
first parameter.
% -----------------------------------------------------------------------------
\subsection{1200: Encrypt packet}
Passes the following information to the crypto engine:
\subsubsection{Parameters}
\begin{longtable}{|c|c|c|c|}
\caption{1200: Encrypt packet}\\
\hline
\textbf{Parameter} & \textbf{Type} & \textbf{Description} & \textbf{Example}\\
\hline
ID & EOFsdt: id & packet id & afdb12\\
\hline
Keyid & EOFsdt:keyid & This peers pgp-keyid & 389E5481065EAA253...\\
\hline
Size & EOFsdt: size & Size of message, excluding this header & 424242\\
\hline
Packet & Binary data & The plaintext & BLOB\\
\hline
\end{longtable}

\subsubsection{Possible answers}
\begin{itemize}
\item 2200
\item 2299
\end{itemize}
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{1201: Decrypt packet}
% -----------------------------------------------------------------------------
\subsection{1202: Sign packet}
% -----------------------------------------------------------------------------
\subsection{1203: Get verified keyid of signer of packet}
% -----------------------------------------------------------------------------
\subsection{2200: Encrypted packet}
\subsubsection{Parameters}
\begin{longtable}{|c|c|c|c|}
\caption{2200: Encrypted packet}\\
\hline
\textbf{Parameter} & \textbf{Type} & \textbf{Description} & \textbf{Example}\\
\hline
ID & EOFsdt: id & packet id of 1200 request & afdb12\\
\hline
Size & EOFsdt: size & Size of packet, excluding this header & 424242\\
\hline
Packet & Binary data & The plaintext & BLOB\\
\hline
\end{longtable}

\subsubsection{Possible answers}
\begin{itemize}
\item none
\end{itemize}
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{2201: Decrypted packet}
% -----------------------------------------------------------------------------
\subsection{2202: Signed packet}
% -----------------------------------------------------------------------------
\subsection{2299: Error}
An unrecoverable error happened. The crypto engine will exit, the EOFi
can restart it afterwards. This may happen due to out-of-memory errors or
library errors.
% -----------------------------------------------------------------------------
% #############################################################################
\section{EOF crypto packets ("`3***: onions"')}
Onions are the result of decrypting an incoming packet (respective vice versa
when sending out).
% -----------------------------------------------------------------------------
\subsection{Introduction}
The following types are defined:

\begin{itemize}
\item 3000: Drop packet
\item 3001: Forward packet
\item 3002: Message / drop packet
\item 3003: Message / forward packet
\item 3004: Acknowledge
\end{itemize}
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Parameters}
All \textbf{3***} packets have the same length and contain the same fields:
\begin{longtable}{|c|c|c|c|c|}
\caption{Command 3*** parameters}\\
\hline
\textbf{Command} & \textbf{id} & \textbf{addr} & \textbf{group} & \textbf{msgtext}\\
\hline
3000 & - & - & - & - \\
\hline
3001 & - & x & - & - \\
\hline
3002 & x & - & x & x \\
\hline
3003 & x & x & x & x \\
\hline
3004 & x & - & - & -\\
\hline
\end{longtable}

\begin{itemize}
\item -: Not used
\item x: Used
\end{itemize}

\begin{longtable}{|c|c|c|c|}
\caption{Command 3*** parameters}\\
\hline
\textbf{Parameter} & \textbf{Type} & \textbf{Description} & \textbf{Example}\\
\hline
id & EOFsdt & Packet id & alg4f!\\
\hline
addr & EOFsdt & Adress of next peer & tcp:123.123.123.132:8080\\
\hline
group & EOFsdt & The destination group & !eof\\
\hline
msgtext & EOFsdt & The message & Hallo, mein Freund!\\
\hline
\end{longtable}
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{3000: Drop packet}
You are the last recipient and there's nothing interesting left.
Just drop the packet and continue work.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{3001: Forward packet}
If a peer receives a packet with the command 3001, it simply forwards
the message to the peer specified in the \textbf{addr} field.
All data contained in the message
is noise. After the message has been forwarded to the next peer, it
should be dropped. If the peer is unreachable, the message should also
be dropped.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{3002: Message / drop packet}
This packet contains a messages to be read and does not need to be forwarded
anymore: You are the last peer in the chain.
\begin{itemize}
\item If the first byte of the group is the zero byte, the message
is a private message (i.e. only sent to you).
\item If the first byte of the group field is \textbf{non-zero} the message
is addressed to the specified group.
\end{itemize}
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{3003: Message / forward packet}
The command 3002 is a combination of command 3001 and 3002.
% -----------------------------------------------------------------------------
\subsection{3004: Acknowledge}
Acknowledge the receipt of a received message. The ID must be the same as
the one specified in the original messages packet.
Every message packet must be acknowledged.
% -----------------------------------------------------------------------------
\section{EOF network packets ("`postcards"')}
\label{postcards}
All data that is transferred over the network must be encrypted.
The EOF packets described in the previous section are multiple times
encrypted and assembled according to the calculated source route.
These packets are codenamed "`postcards"', as it is assumed they can be read
by an attacker.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Routing}
This version of EOF does not know how to create a route.
All packages are transferred directly to the final peer (which is an
incredible big huge bug) in this version of EOF. Source routing will be
described and defined in future versions.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Onion packets}
An onion packet is a (multiple times) encrypted packet.
An onion packet contains at least one plaintext packet, but can also contain
already encrypted packets. It may look like as follows:
% -----------------------------------------------------------------------------
\subsubsection{Example onion packet}
\begin{itemize}
\item 
\end{itemize}
% Nico: FIXME for 1.0
% -----------------------------------------------------------------------------
\subsection{Postcard packets}
A postcard "`packet"' contains one onion packet plus the transport protocol
shell.  Postcard packets are the only packet type that is seen by a possible
attacker.  The name postcard was choosen to reflect the fact, that anyone
passing the postcard can read what is written on it.

All packets must be signed by the sender and encrypted for the receiver.
The different datatypes are just concatenated in the order described.
The following description of the content describes the pakckets
in their unencrypted form.

% Nico: 1.0
% #############################################################################
\chapter{Transport protocols}
% -----------------------------------------------------------------------------
\section{Introduction}
Only lower-case names are allowed (to prevent problems with broken filesystems).
% -----------------------------------------------------------------------------
\section{Examples}
This sections shows some theoretic (theoretic because nobody implemented
them yet) transport protocols.
% -----------------------------------------------------------------------------
\subsection{tcp}
% -----------------------------------------------------------------------------
\subsection{tcps}
% -----------------------------------------------------------------------------
\subsection{udp}
% -----------------------------------------------------------------------------
\subsection{http}
% -----------------------------------------------------------------------------
\subsection{https}
% -----------------------------------------------------------------------------
\subsection{smtp}
connect to smtp server
% -----------------------------------------------------------------------------
\subsection{smtps}
% -----------------------------------------------------------------------------
\subsection{mediawiki}
url, user, password
% -----------------------------------------------------------------------------
\subsection{smb}
write on windows shares
% -----------------------------------------------------------------------------
\subsection{mailto}
Write an email to some address. Needs smtp-server set in configuration.
May have different methods for retrieval (like connecting to imap,pop,
read from mbox/maildir directly).
% -----------------------------------------------------------------------------
\subsubsection{Example URLs}
\begin{verbatim}
mailto:nico-eof@eof.eof.name
\end{verbatim}
% -----------------------------------------------------------------------------
\subsection{dns}
Use dns traffic to transport EOF protocols.
% -----------------------------------------------------------------------------
\subsection{media}
like images, videos, sounds, real noise, spam, ...
% -----------------------------------------------------------------------------
\section{Embedding into EOF}
This section explains how to integrate a transport protocol into EOF.
% -----------------------------------------------------------------------------
\subsection{Adding a transport protocol}
If you want to add the transport protocol \emph{tptest}:
\begin{itemize}
\item Create the directories
\begin{itemize}
\item \textbf{\$HOME/.ceof/tp/available/\emph{tptest}}.
\end{itemize}
\item Create (link or copy) the executables to the filenames \textbf{listen}
and \textbf{send}.
\end{itemize}
The EOF implementation will register the transport protocol automatically
at the next start. You may register only the \textbf{listen} or
\textbf{send} part of a protocol.
% -----------------------------------------------------------------------------
\subsection{Using a transport protocol}
So far the EOF implementation knows about the implementation, and may also
already use it for \emph{sending} packets. But there is no listener configured
yet.
To enable a listener for the protocol \emph{tptest} at the URL
\emph{tptest:somewhere@protocol-specific}
\begin{itemize}
\item create a directory below
\begin{itemize}
\item \textbf{\$HOME/.ceof/tp/enabled/}
\end{itemize}
\item with a name of your choice (f.i. \emph{tptest-somwhere} or \emph{http-80}).
\item Then add the URL to the file named $<\textbf{url}>$.
\item If the transport protocol needs or allows additional configuration files,
you need to create them in that directory.
\end{itemize}
The EOF implementation will parse the URL and check whether a supporting
listener application is available.

Will do chdir() to the directory! tp can open config files in current dir.
what about url?

same for listen and send?
   listenurl, sendurl, config in curdir
Yes!

The maximum length of the URL is defined in eof.h (EOF\_L\_ADDRESS).
If it is longer, it will be truncated after \textbf{EOF\_L\_ADDRESS} bytes.

IMPORTANT!
% -----------------------------------------------------------------------------
\section{Implementations}
The following sections cover existent protocol implementations.
The name of the section is the name of the registered implementation.
Every section must at least contain:
\begin{itemize}
\item Supported scheme
\item Author contact information
\item URL of website
\item Programming language
\item EOF-Version that introduces support for the protocol
\end{itemize}
You should add your implementation to the directory "`tp"' within the
repository.
Sort sections by alphabet.

% FIXME: maybe create a longtable containing all protocols
% FIXME: only add further information to subsections
% -----------------------------------------------------------------------------
\subsection{dummy/c}
\begin{itemize}
\item dummy
\item Nico Schottelius [nico-eof-tp-dummy-c =at= schottelius.org]
\item https://www.eof.name
\item C
\item Version: 1
\end{itemize}
% -----------------------------------------------------------------------------
\subsection{tcp-apic}
\begin{itemize}
\item tcp
\item A. Pic
\item ?
\item C
\item Version: 1
\end{itemize}
% -----------------------------------------------------------------------------
\appendix
\chapter{Sources}
\begin{thebibliography}{42}
\bibitem{pgp-1} http://en.wikipedia.org/wiki/Public-key\_cryptography
\bibitem{onion-1} http://en.wikipedia.org/wiki/Onion\_routing
\bibitem{tor-1} https://wiki.torproject.org/noreply/TheOnionRouter
\bibitem{irc-1} RFC 1459: http://www.irchelp.org/irchelp/rfc/rfc.html
\bibitem{source-routing-1} http://en.wikipedia.org/wiki/Source\_routing
\bibitem{tcp-1} RFC 793: http://www.faqs.org/rfcs/rfc793.html
\bibitem{http-1} RFC 2616: http://www.faqs.org/rfcs/rfc2616.html
\bibitem{smtp-1} RFC 2821: http://www.faqs.org/rfcs/rfc2821.html
\bibitem{avian-1} RFC 1149: http://www.faqs.org/rfcs/rfc1149.html
\bibitem{uri-1} RFC 3986: http://www.faqs.org/rfcs/rfc3986.html
\bibitem{!eof} https://www.eof.name
\bibitem{stegano-1} http://en.wikipedia.org/wiki/Steganography
\bibitem{utf8} RFC3629: UTF-8: http://www.ietf.org/rfc/rfc3629.txt
\end{thebibliography}

\printindex
\end{document}
