\documentclass[12pt,a4paper]{book}
\usepackage[latin1]{inputenc}    % Ascii-Format dieses Dokuments
\usepackage{longtable}           % lange Tabellen
\usepackage{makeidx}             % indexing
\makeindex

\begin{document}
\title{EOF\\Eris Onion Forwarding\\
The secure, peer-to-peer, decentralised anonymous chat network}
\date{2009-03-12}
\author{Nico -telmich- Schottelius, !eof}

\maketitle
\tableofcontents
%\newpage

% -----------------------------------------------------------------------------
\chapter{Introduction}
% ----------------------------------------------------------------------------
\section{Copying}
Copy it as you like - send corrections to me.
% Nico: 1.0
% FIXME: Free, see creative commons!
% -----------------------------------------------------------------------------
\section{Abstract}
EOF is a chat protocol that supports secure chatting.
Secure chatting consists of the following features:
\begin{enumerate}
\item Nobody, but the intended receiver(s) know(s) \emph{that} you wrote a message.
\item Nobody, but the intended receiver(s) can view the \emph{message content}.
\item Nobody, but the intended receiver(s) can \emph{verify} the source of the message being you.
\item Nobody, but the intended receiver(s) know(s) \emph{who} you sent a message to.
\item The network must survive attacks of a single attacker.
\item Hard (if not practilcally impossible) to block chatting.
\end{enumerate}
Additionally, for practical reasons, EOF must support the following
chat features:
\begin{enumerate}
\item Direct chat ("`message is only seen by one person"')
\item Group chat ("`message is sent to specific group, which may consist of
more than one person"')
\end{enumerate}
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Hide message sending}
We don't think it's possible to hide that you are part of the chat network,
because some heuristics will be developed to detect the chat packets.
So we use a different idea:
Every participant of an EOF network will constantly send chat packets
with a pre-defined frequency (for instance every 250 ms).
If you don't chat, \emph{noise} is sent.\footnote{Noise is just random
data, see below for a more detailled description of noise.}
The noise is also used to defend against timing analysis.
In case you are sending out a message, the message packet will be added to the
queue and sent within the next free time slot.

From outside it can easily be seen, that you are part of the network,
but not, if you sent a message.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Hide message content}
We encrypt every message via public-key cryptography\cite{pgp-1},
so that only the receiver can decrypt and view the message content.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Verify sender}
Before the encrypt the packet, it is signed via public-key
cryptography\cite{pgp-1}. Thus only the receiver can verify the message sender.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Hide message receiver}
The message packets are always sent indirectly via onion routing\cite{onion-1}.
The idea is taken from the Tor project\cite{tor-1}, though EOF uses an enhanced
version: EOF does not know about entry or exit nodes. If you are the intended
receiver you may or may not continue to forward the message, which is defined
by the sender of the message. That said, EOF must use source
routing\cite{source-routing-1}.

To support onion routing, the sender of a packet needs to encrypt the packet
multiple times, once for each host that receives the packet. This may look
as follows:
\begin{enumerate}
\item Create message (from noise or user input)
\item Create source path
\item Create packet for last peer ("`pkg-last"')
\item Create packet for last-1 peer including \emph{pkg-last}
\item Continue until first peer is reached
\item Sent packet to first peer
\end{enumerate}
Thus every peer only knows the previous and the next peer.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Reliable against single user attacks}
Traditional chat networks depend on one or more central organised servers.
An attacker can stop all communication, if she runs a successful denial
of service ("`DoS"') attack against the central systems.
To protect against this, EOF uses a dynamic peer-to-peer network, which works
as long as the minimun number of peers and the destination peer is available.
It has no dependency on a central server.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Hide packets in network stream}
As said before, we don't think it's possible to hide the participation in the
chat network. To be able to send packets, although an attacker \emph{knows}
about the participation, EOF embeds all chat packets into other (well known)
protocols.
EOF does not implement nor specify \emph{transport protocols} itself.
The EOF community is urged to implement them in a creative way: Usage
of well-known protocols like TCP\cite{tcp-1}, HTTP\cite{http-1},
SMTP\cite{smtp-1} or even transmission of packets on avian
carriers\cite{avian-1} are encouraged. The tunneling of EOF packets through
those protocols (also know as obfuscation) makes it harder to detect
and \emph{block} EOF traffic.
If an attacker wants you to stop sending messages, she has to completly
remove you from the network, because any open protocol may be (ab)used to
encapsulate EOF packets into it.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Real world usability}
To be able to be compete with other chat protocols, EOF needs
to support \emph{direct} and \emph{group chat}, which is
implemented by two different chat destinations:
\begin{enumerate}
\item \emph{Peers}
\item \emph{Groups of peers}
\end{enumerate}
A peer is just another person (direct chat), a group of peers is the EOF
equivalent of the IRC channel\cite{irc-1}. As there is no central server,
groups of peers are managed by each client, and thus the compositions of
group members may be different on different peers.
% Nico: 1.0
% -----------------------------------------------------------------------------
\section{Motivation}
% -----------------------------------------------------------------------------
\subsection{Current implementations are not secure}
There are already many different chat protocols available like
\begin{itemize}
\item talk
\item IRC
\item SILC
\item Jabber
\item ICQ
\item Skype
\end{itemize}
Only two of those protocols contains mandority encryption (SILC, Skype), which
still lacks many features for secure chatting.\footnote{Most of them can be
enhanced to use TLS/SSL, but this is not enforced.} Skype and SILC still
depend on a central server architecture. The Skype architecture is not
publicly documentated, the executing binary is encrypted, and the system
depends on a single company, which excluded it from being a secure chat
system.

Because SILC depends on a central server architecture, it was also excluded.
% Nico: 1.0
% FIXME: add references for protocols!
% -----------------------------------------------------------------------------
\subsection{Create more crypto traffic}
We also want to convey usage of PGP: currently PGP is quite seldom.
Thus if you use PGP, you may be conspicuous. We try to make PGP encrypted
packets part of the regular internet traffic, like webtraffic is today.
% Nico: 1.0
% FIXME: add references for PGP
% -----------------------------------------------------------------------------
\section{The project}
The project started in 2007 as an idea of !eof\cite{!eof}
(a friendly hacker community). After several meetings it was clear that
we need to do some experiements and create phases to structure the
development.
% -----------------------------------------------------------------------------
\subsection{The three phases}
So we divided the project into the three phases
\begin{enumerate}
\item \emph{EOF-1},
\item \emph{EOF-2},
\item \emph{EOF-3}.
\end{enumerate}
% -----------------------------------------------------------------------------
\subsubsection{EOF-1: Finding ideas}
The first phase was the so called "`finding ideas"' phase. We did some tests,
measured packet sizes and did some theorethic calculations on intervals.
There was also some discussion about implementing EOF in a ring structure,
like token ring\cite{token-ring}.
The first try to do the first implementation as a complet modularised
version began and stalled after some months of decentral developemnt.
% FIXME: cite
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsubsection{EOF-2: Proof of concept}
We are currently working on a prototype in EOF-2. The idea is to get the
basic features working and to attract testers and developers.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsubsection{EOF-3: The final destination}
The idea of EOf-3 is to cleanup all parts of EOF-2 and create a
"`ready to be used"' software package, that may be used by end users.
This includes "`good documentation"' (this document).
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Further directions}
After the deployment of EOF-3, there may be more work necessary, like
\begin{itemize}
\item Deep analysis of security (by us and foreigners),
\item enhance performance,
\item port to other systems,
\item adapt to changed environment,
\item \ldots{}
\end{itemize}
% Nico: 1.0
% -----------------------------------------------------------------------------
\section{Conventions}
% -----------------------------------------------------------------------------
\subsection{Writing convention}
There are not many things to take care about, when reading this document:
\begin{itemize}
\item We use \emph{\$NAME} to mark an environment variable.
\item Parameters enclosed in $<$ and $>$ must be specified to the command.
\item Parameters enclosed in $[$ and $]$ can be specified optionally.
\item \emph{EOF\_L\_\textit{NAME}} is used to specify a certain length
\end{itemize}
% Nico: 1.0
% FIXME: is this used anywhere?
% FIXME: Reference for env vars?
% -----------------------------------------------------------------------------
\subsection{Abbreviations}
As some terms are quite often used, we created some abbreviations:
\index{abbreviations}%
\index{EOF (abreviation)}%
\index{EOFi (abreviation)}%
\index{rEOFi (abreviation)}%
\index{EOFs (abreviation)}%
\index{FLS (abreviation)}%
\begin{longtable}{|c|c|}
\caption{List of abbreviations}\\
\hline
\textbf{Abbreviation} & \textbf{Meaning}\\
\hline
EOF & Eris onion forwarding, name of this project\\
\hline
EOFi & An EOF implementation\\
\hline
rEOFi & The reference EOF implementation (also called "`ceofhack"')\\
\hline
EOFs & An EOF subsystem\\
\hline
EOFsdt & EOF simple data type\\
\hline
FLS & Fixed length string\\
\hline
\end{longtable}
% Nico: 1.0
% -----------------------------------------------------------------------------
\chapter{The EOF standard}
This section defines the complete EOF standard. All required operations,
features, protocol specifications, paths, interfaces and environment definition,
etc. are described.
% Nico: 1.0
% -----------------------------------------------------------------------------
\section{Version}
As soon as this standard is usable and the first version of \emph{rEOFi}
is released, it will version number \textbf{01} of the standard.
Further changes will be documented in this section. All version numbers
are two ASCII digits (see below).
% Nico: FIXME for 1.0
% -----------------------------------------------------------------------------
\section{Interface description ("`eofi2any"')}
This section defines which interfaces EOFi offers to communicate with
subsystems in general. Each subsystem may use a subset or the full set
of interfaces, which is defined in their respective sections.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Stdin, stdout and stderr (via pipes)}
EOFi is capable of executing a program and connecting its STDIN, STDOUT and
STDERR to EOFi. The rEOFi uses pipes, but other EOFis may use different
methods.\footnote{See pipe(2) and forkexecpipe() in rEOFi.}
The three filehandles are used as follows:
\begin{longtable}{|c|c|}
\caption{Stdin, stdout, stderr}\\
\hline
\textbf{Name} & \textbf{Used for}\\
\hline
stdin & Commands sent from EOFi\\
\hline
stdout & Commands sent from EOFs\\
\hline
stderr & Diagnostic messages sent from EOFs\\
\hline
\end{longtable}
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Unix Sockets}
Unix sockets are provided by EOFi to allow external applications to
connect to EOFi.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Environment variables}
The following environment variable are either used or set by EOFi and are
available for all EOFs.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsubsection{\$HOME}
The home directory of the user. It is required by EOFi to locate the
configuration directory.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsubsection{\$CEOF\_HOME}
The ceof configuration directory. If set by before EOFi starts, it will
skip the autodetection of the configuration directory.
This variable is exported to all EOFs.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsubsection{\$CEOF\_UI\_SOCKET}
This variable contains the absolute path to the socket, which should be used
by user interfaces (UIs).
% Nico: 1.0
% -----------------------------------------------------------------------------
\section{Paths}
% -----------------------------------------------------------------------------
\subsection{EOFi configuration directory}
% -----------------------------------------------------------------------------
\subsubsection{Default case}
Normally, \$HOME is set and \$CEOF\_HOME is not set. In that case
the configuration directory defaults to \textit{\$HOME/.ceof}.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsubsection{\$HOME is unset}
If the environment variable "`\textit{\$HOME}`" is not set,
the directory named \textit{.ceof} in the current directory will be used.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsubsection{\$CEOF\_HOME is set}
If the environment variable "`\textit{\$CEOF\_DIR}`" is set,
its content will be used to refer to the configuration directory.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{User interface socket}
The user interfaces connect to a socket specified in
\textit{\$CEOF\_UI\_SOCKET}.
% Nico: 1.0
% -----------------------------------------------------------------------------
\section{Configuration}
The configuration of EOFi is stored in the cconfig\cite{cconfig} format.
% Nico: FIXME for 1.0: cite
% -----------------------------------------------------------------------------
\section{Basic data types}
This section specifies the basic datatypes used in EOF.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{The zero byte}
The zero byte is a byte with the value 0.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Line feed}
The line feed, "`\textbackslash{}n"', is often used to terminate data
sections.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{ASCII numbers}
ASCII numbers use the decimal string representation of a number (versus
binary representation, which is \emph{never} used between EOFi and EOFs).
ASCII numbers are often used in a packet header and terminated by a
line feed. ASCII numbers are used to specify the length of the packet
(excluding itself).
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Strings in general}
Strings are transmitted without termination (i.e. no new line, no 0 byte),
but are padded with zero bytes, if shorter than the specified length.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Fixed length strings}
Fixed length strings contain exactly the specified number of bytes:
A 128-byte fixed length string consists of at most 128 bytes of text,
which is then not zero terminated!
If the text it contains is shorter than the specified length,
it must be padded with zero bytes.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Variable length strings}
The EOF protocol currently does not specify any variable length strings.
All strings are fixed length (see above).
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Noise}
There are many situations in which an EOFi sends out data to the network,
although you did not write a message: In fact, as EOFi \textbf{always}
sends packets in a fixed interval, it needs to have data to encrypt and send.

Noise can be any type of random data. As the current random number generators
are quite expensive, it is recommend to use a huge dictionary for noise
input.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Unused}
To make life harder for attackers we try to make packets always be more or
less the same size. That results in fields being present in a packet, which
are unsued.

Unused fields should be filled up with noise.
% Nico: 1.0
% #############################################################################
\section{Sizes}
\index{eof.h (File)}%
All sizes used in this document are "`symbolic sizes"': The real size
is defined in the attached file "`\emph{eof.h}"'.
Developers are advised to use the symbolic name in their programs.
% Nico: 1.0
% #############################################################################
\section{EOF simple data types ("`EOFsdt"')}
The following sections define the datatypes used in EOF related
applications. The recommened name for use in source
code is added in parentheses after the human understandable name.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Nick name (nick)}
The peer name is a \emph{EOF\_L\_NICKNAME} byte fixed length string.
It is only used internally to give a peer a rememberable name ("`a nick'").
It is never transmitted over the network.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Channel name (channel)}
The channel name is a \emph{EOF\_L\_CHANNEL} byte fixed length string.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Message text (msgtext)}
The message text is a \emph{EOF\_L\_MESSAGE} byte fixed length string.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Peer address (address)}
The address of a peer, which is is a \emph{EOF\_L\_ADDRESS}
byte fixed length string. Peer addresses are specified as
URLs as defined in RFC3986\cite{uri-1}. For more information have
a look at section \ref{tp} on page \pageref{tp}.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Fingerprint (fpr)}
A (PGP) fingerprint is a \emph{EOF\_L\_KEYID} byte fixed length string.
% Nico: 1.0
% -----------------------------------------------------------------------------
\section{EOF Commands}
An EOF command is exactly \emph{EOF\_L\_CMD} bytes long (fixed length string)
and contains an ASCII number.

EOF commands are the main method of telling for communication between
EOFs and EOFi.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Command fields}
The command field 0 indicates the direction.
The command field 1 indicates the EOF subsystem.
\begin{longtable}{|c|c|}
\caption{Command fields 0 and 1}\\
\hline
\textbf{Value} & \textbf{Subsystem} / \textbf{Description}\\
\hline
1*** & Message is coming from the EOF implementation\\
\hline
10** & \textbf{eofi2tp}: Transport protocols\\
\hline
11** & \textbf{eofi2ui}: User interface\\
\hline
2*** & Message is coming from EOF subsystem (internally)\\
\hline
20** & \textbf{eofi2tp}: Transport protocols\\
\hline
21** & \textbf{eofi2ui}: User interface\\
\hline
3*** & Message is coming from outside (received packet))\\
\hline
\end{longtable}
The command fields 2 and 3 are defined by the respective subsystem.
% Nico: 1.0
% -----------------------------------------------------------------------------
\section{EOF packets ("`pkg2eofi"')}
% -----------------------------------------------------------------------------
\subsection{Maximum packet size}
No packet (including everything) may exceed the size of \emph{EOF\_L\_PKG\_MAX}.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Types of packets}
EOF knows about encrypted ("`Onion packets"') and
unencrypted ("`plaintext packets"') packets.
Only encrypted packets are sent out on the network.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Plaintext packets}
Plaintext packets are used for the communication Inside of EOFi and EOFs.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Onion packets}
An onion packet is a (multiple times) encrypted packet.
An onion packet contains at least one plaintext packet, but can also contain
already encrypted packets. It may look like as follows:
% -----------------------------------------------------------------------------
\subsubsection{Example onion packet}
\begin{itemize}
\item 
\end{itemize}
% Nico: FIXME for 1.0
% -----------------------------------------------------------------------------
\subsection{Postcard packets}
A postcard "`packet"' contains one onion packet plus the transport protocol
shell.  Postcard packets are the only packet type that is seen by a possible
attacker.  The name postcard was choosen to reflect the fact, that anyone
passing the postcard can read what is written on it.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Packet layout}
All EOF packets begin with an EOF command. Packets that leave the internal
flow of EOFi and EOFs are encrypted ("`Onion packets"') and encapsulated into
a transport protocol specific packet ("`postcard packet"').
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{Noise}
Dictionary, old messages, random data,
"`Lightweight random data"': Wordlists, E-Mails, ...
All packets must be signed by the sender and encrypted for the receiver.
The different datatypes are just concatenated in the order described.
The following description of the content describes the pakckets
in their unencrypted form.
% FIXME: create type
% -----------------------------------------------------------------------------
\subsection{3000: Message}
The command 3000 is placed in front of the message packet and is
followed \emph{EOF\_L\_MESSAGE} bytes for the message.
\index{Command!3000}%
\begin{longtable}{|c|c|c|c|}
\caption{Command 3000 parameters}\\
\hline
\textbf{Parameter} & \textbf{Type} & \textbf{Description} & \textbf{Example}\\
\hline
address & EOFsdt & unused in cmd 3000  &\\
\hline
channel & EOFsdt & The destination channel & !eof\\
& Starts with a zero byte, if unused. &mein Freund!\\
\hline
msgtext & EOFsdt & The main purpose of a chat  & Hallo, mein Freund!\\
\hline
\end{longtable}
% -----------------------------------------------------------------------------
\subsection{3001: Forward packet}
If a peer receives a packet with the command 3001, it simply forwards
the message to the specified peer. All data contained in the message
is noise. After the message has been forwarded to the next peer, it
should be dropped. If the peer is unreachable, the message should also
be dropped.
\index{Command!3001}%
\begin{longtable}{|c|c|c|c|}
\caption{Command 3001 parameters}\\
\hline
\textbf{Parameter} & \textbf{Type} & \textbf{Description} & \textbf{Example}\\
\hline
msgtext & \emph{EOF\_L\_MESSAGE} byte FLS & The main purpose of a chat  & Hallo, mein Freund!\\
\hline
\end{longtable}

\begin{itemize}
\item Command type "`8003"'
\item Peer fingerprint
\item Peer address
\item Padding
\end{itemize}
% -----------------------------------------------------------------------------
\subsection{3002: Message and forward}
The packet contains a message for you, the rest has to be forwarded.
% -----------------------------------------------------------------------------
\subsection{3003: Drop packet}
You are the last recipient and there's nothing interesting left.
Just drop the packet and continue work.
% Nico: 1.0
% -----------------------------------------------------------------------------
\subsection{EOF network data types}
These datatypes are transmitted over the network and are only
encapsulated by the specific network protocol.
% -----------------------------------------------------------------------------
\subsection{General network packet}
\begin{itemize}
\item Type of packet
\item Next receiver: Peer address
\item Message text
\end{itemize}
% -----------------------------------------------------------------------------
% #############################################################################

% -----------------------------------------------------------------------------
\section{Transport protocols ("`eofi2tp"')}
\label{tp}
Environment variables: CWD for listener
URLs are used as defined in RFC3986\cite{uri-1}.
Transport protocols use EOF command ID 0.

Stateless: source routing, usage of acks.

Unterscheiden zwischen listener und send.
% -----------------------------------------------------------------------------
\subsection{1000: Send packet}
\index{Command!1000}
\begin{longtable}{|c|c|c|c|}
\caption{Command 1000 parameters}\\
\hline
\textbf{Parameter} & \textbf{Type} & \textbf{Description} & \textbf{Example}\\
\hline
Destination & 128 Byte FLS &URL without "`\emph{scheme:}"' & 127.0.0.3:42\\
\hline
Size & ASCII Number + \textbackslash{}n & Size of message, excluding this header & 424242\\
\hline
Message & Binary data & The message & BLOB\\
\hline
\end{longtable}
The ASCII number may not exceed the value 999999. Thus if there is no
\emph{\\n} after 6 bytes, the package is damaged or malformed.
% -----------------------------------------------------------------------------
\subsubsection{1000: Example}
Added linebreak after some \\0 for readability, which are \textbf{not} in
the real packet!
\begin{verbatim}
1000127.0.0.3:42\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0
\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0
\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0
\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\010
HEREISDATA
\end{verbatim}
% -----------------------------------------------------------------------------
\subsection{1001: Enable listening}
\index{Command!1001}%
When the listening transport protocol starts up, EOFi sends this command and
waits for an acknowledge (\emph{2003}, before it marks the
listening transport protocol as enabled.
\begin{longtable}{|c|c|c|c|}
\caption{Command 1001 parameters}\\
\hline
\textbf{Parameter} & \textbf{Type} & \textbf{Description} & \textbf{Example}\\
\hline
Destination & 128 Byte FLS & URL without "`\emph{scheme:}"' & 127.0.0.3:42\\
\hline
\end{longtable}
% -----------------------------------------------------------------------------
\subsubsection{1001: Example}
\begin{verbatim}
1001127.0.0.3:42\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0
\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0
\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0
\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0
\end{verbatim}
% -----------------------------------------------------------------------------
\subsection{1002: Stop listening}
\index{Command!1002}%
This command requests a listening transport protocol to 
shutdown. It should free all ressources and exit.
After a grace time (maybe seconds, not yet defined), EOFi will kill the badly
behaving transport protocol.
listening transport protocol as enabled.
\begin{longtable}{|c|c|c|c|}
\caption{Command 1001 parameters}\\
\hline
\textbf{Parameter} & \textbf{Type} & \textbf{Description} & \textbf{Example}\\
\hline
\end{longtable}
% -----------------------------------------------------------------------------
\subsubsection{1002: Example}
\begin{verbatim}
1002
\end{verbatim}
% -----------------------------------------------------------------------------
\subsection{2000: Packet successfully sent}
This code is returned by the transport protocol subsystem to EOFi on success.
After this return code, the transport protocol exits.
% -----------------------------------------------------------------------------
\subsubsection{Example}
\begin{verbatim}
2000
\end{verbatim}
% -----------------------------------------------------------------------------
\subsection{2001: Packet not sent}
\index{Command!2001}
This code is returned by the transport protocol subsystem to the
EOF implementation on failure.
After this return code, the transport protocol exits.
% -----------------------------------------------------------------------------
\subsubsection{Example}
\begin{verbatim}
2001
\end{verbatim}
% -----------------------------------------------------------------------------
\subsection{2002: Received packet}
\index{Command!2002}
The listening transport protocol received a packet and notifies EOFi.
\begin{longtable}{|c|c|c|c|}
\caption{Command 2002 parameters}\\
\hline
\textbf{Parameter} & \textbf{Type} & \textbf{Description} & \textbf{Example}\\
\hline
Size & ASCII Number + \textbackslash{}n & Size of message, excluding this header & 424242\\
\hline
Message & Binary data & The message & BLOB\\
\hline
\end{longtable}
% -----------------------------------------------------------------------------
\subsubsection{Example}
\begin{verbatim}
200212
RECEIVEDDATA
\end{verbatim}
% -----------------------------------------------------------------------------
\subsection{2003: Listening}
\index{Command!2003}
This code is returned by the listening transport protocol, as soon as the
listening process is ready to receive data. After that, EOFi can announce
the listening URL to other EOFi.
% -----------------------------------------------------------------------------
\subsubsection{Example}
\begin{verbatim}
2003
\end{verbatim}
% -----------------------------------------------------------------------------
\section{The user interface ("`ui2user"')}
This section specifies the appereance of a user interface to the user.
All EOF compliant user interfaces must support the named commands, so the
user can change the UI, but can be sure that this minimal amount of
commands is always available.  This section is based on the specification
written by apic, ilo, telmich on 2008-08-17 (Version v0.3-triemli).

\subsection{Minimal philosophy}
This specifications describes all the commands that \textbf{must} be
supported by every client. This means clients may have additional possibilities
to send commands via different methods (like clicking on a button or via
voice input), but they must support all of the commands listed, because this
way the user always has the familiar commands available.

\subsection{Changelog}
\subsubsection{v0.1-mrmcd110b to v0.2-train}
   \begin{itemize}
      \item Renamed \textbf{mslist} to \textbf{mlist}, so it is consequently the prefix
      "`m"' for marktschreier.
      \item Some minor language cleanup 
      \item Added "`minimal philosophy"'
      \item Added minimal writing convention
      \item Added /peer commands
      \item Gave the document some structure
      \item \textbf{Change by}: telmich
   \end{itemize}

\subsection{Commands in general}
All commands begin with a "`/"' as first character (adopted from IRC).
%---------------------------------------------------------------------
\subsection{Command length}
The user intertace shall only accept commands up to a langth of 256 Byte.
If the user inputs longer commands, they must be truncated
to 256 Bytes.
%---------------------------------------------------------------------
\subsubsection{Send text}
If there is no /, it should be assumed that it is a message.
The text will be send to the currently selected channel or nick.

%---------------------------------------------------------------------
\subsubsection{/join $<marktschreier>$ $<channel>$}
Join the specific channel on the specified marktschreier.
TO BE REWORKED
POST ceofhack-0.1
%---------------------------------------------------------------------
\subsubsection{/list $<markschreier>$}
List available channels on specified marktschreier.
TO BE REWORKED
POST ceofhack-0.1

%---------------------------------------------------------------------
\subsection{/mlist}
List connected marktschreier.
TO BE REWORKED
POST ceofhack-0.1

%---------------------------------------------------------------------
\subsection{/mconnect $<marktschreier>$}
Connect to marktschreier.
TO BE REWORKED
POST ceofhack-0.1

%---------------------------------------------------------------------
\subsection{/whois $<nick>$}
Display detailled information about a nick:
\begin{itemize}
\item PGP details
\begin{itemize}
\item Fingerprint
\item Full name
\item E-Mail
\end{itemize}
\item List of transport protocols with status
\end{itemize}

Implement in ceofhack-0.1!
%---------------------------------------------------------------------
\subsection{/clist $<channel>$}
Display nicks in the specified channel.
TO BE REWORKED
POST ceofhack-0.1

%---------------------------------------------------------------------
\subsection{/leave $<channel>$}
Leave a channel.

POST ceofhack-0.1


%---------------------------------------------------------------------
\subsection{/peer add $<$name$>$ $<$initial address$>$ $<$fingerprint$>$}
Add the peer as \textit{name} to the list of known peers
and connect to it, to retrieve other addresses.
\begin{itemize}
\item \textit{name} is 128 Bytes, including 0-byte termination.
If the name is shorter it is padded with 0-bytes.
\item \textit{initial address} is 128 Bytes, including 0-byte termination.
If the initial address is shorter it is padded with 0-bytes.
\end{itemize}

TO BE REWORKED

Implement in ceofhack-0.1!

Length: as in ceofhack.h
%---------------------------------------------------------------------
\subsection{/peer rename $<$oldname$>$ $<$newname$>$}
Renames the peer.
%---------------------------------------------------------------------
\subsection{/peer send $<$name$>$ $<$msg$>$}
Send message \textit{msg} to peer \textit{name}.
%---------------------------------------------------------------------
\subsection{/peer list}
List currently known peers.

Implement in ceofhack-0.1!
%---------------------------------------------------------------------
\subsection{/quit}
Tell ceof to quit, ceof tells all GUIs and subcomponents to quit and quits.
%---------------------------------------------------------------------

\subsection{Aliases}
Those commands are recommended for easier integration of new people using EOF.
%---------------------------------------------------------------------
\subsection{/msg $<nick>$ $<message>$}
Is an alias for \textit{/peer send $<$name$>$ $<$message$>$}
%---------------------------------------------------------------------
\subsection{/names}
Display nicks in the currently active channel.

Make alias recommendation, not to be implemented directly.

POST ceofhack-0.1
%---------------------------------------------------------------------
\section{Interface to the user interface ("`eofi2ui"')}

Version: 2007-11-16 v0.3-bed / telmich
This document specifies the commands send from GUI to and from
ceof\footnote{the central EOF-1 application} to the GUIs.
% -----------------------------------------------------------------------------
\subsection{Changelog}
% -----------------------------------------------------------------------------
\subsubsection{draft-1 to v0.2-bed}
\begin{itemize}
\item Many cleanups
\item Changed socket location
\item Clearified what todo without \textit{CEOF\_DIR} and \textit{HOME} set
\item Added exit command.
\item Changed number of bytes for marktschreier from 512 Bytes to 128 Bytes
\item Changed number of bytes for channel name  from 512 Bytes to 128 Bytes
\item Added ranges (001-00x)
\end{itemize}
% -----------------------------------------------------------------------------
\subsubsection{v0.2-bed to v0.3-bed}
\begin{itemize}
\item Add fingerprint to \textbf{0021}
\item Add command \textbf{0023}: Retrieve peer fingerprint
\item Link to the basic documentation
\end{itemize}
% -----------------------------------------------------------------------------
\subsection{Connection}
Use the ceof client socket, as specified in the basic documentation.
% -----------------------------------------------------------------------------
\subsection{Command overview}
All commands are send as 4-Byte ASCII digits (for instance "`0012"').
All answers and all numbers are ASCII-numbers. We
\textbf{never} transmit binary numbers.
\textbf{Client commands} always begin with \textbf{0} ("`0042"' for instance),
\textbf{answers} or \textbf{notifications} from
\textbf{ceof} begin with \textbf{1} ("`1023"' for instance).
After each command follows individual data. The second byte indicates the type of message:
\begin{itemize}
\item \textbf{00}: client meta command (something that does not affect the user)
\begin{itemize}
\item \textbf{000}: (De-)Initialisation
\item \textbf{001}: Marktschreier related
\item \textbf{002}: Peer related
\item \textbf{003}: Channel related
\end{itemize}
\item \textbf{01}: messages
\item \textbf{11}: sucess answers from ceof
\item \textbf{12}: error answers from ceof
\item \textbf{13}: messages / notifications initiated by ceof
\end{itemize}

% -----------------------------------------------------------------------------
\subsection{0000: Register client}
After the "`0000"' the client directly appends two ASCII digits containing the
version of the client to ceof protocol it speaks. This specification uses version
"`04"'.
Answers from ceof:
\begin{itemize}
\item \textbf{1100}: success, you are connected
\item \textbf{1200}: version not supported
\end{itemize}
% -----------------------------------------------------------------------------
\subsection{0001: Deregister client}
This client derigesters from ceof. Ceof will keep on running, even if this
was the last client.
Answers from ceof:
\begin{itemize}
\item \textbf{1101}: sucess, you are disconnected
\end{itemize}
% -----------------------------------------------------------------------------
\subsection{0009: Request for exit}
Tells ceof to exit and to notify all guis to exit.
It will not reply anything to you, but issue an exit notify to all clients,
including the requesting one.
% -----------------------------------------------------------------------------
% -----------------------------------------------------------------------------
\subsection{0010: List connected markschreiers}
Answers from ceof:
\begin{itemize}
\item \textbf{1102}: list follows
\begin{itemize}
\item four ASCII-digits containing number of peers ("`num\_peer"')
\item after that follow \textit{num\_peer} peer ids:
\begin{itemize}
\item 128 Byte containing the peer name (if shorter it is padded with 0-bytes), 0 terminated
\item 40 Byte containing the fingerprint of the
key\footnote{See RFC 2440, 11.2. Key IDs and Fingerprints}
\end{itemize}
\end{itemize}
\end{itemize}
% -----------------------------------------------------------------------------
% ok
% -----------------------------------------------------------------------------
\subsection{0011: Connect to markschreier}
After the "`0011"' follow 128 Bytes describing how to connect
to the marktschreier ("`tcp://62.65.138.66:42'" for instance).
If the URI is shorter than 128 bytes, the remain should be filled with 0 bytes
(also known as \verb='\0'=).

Answers from ceof:
\begin{itemize}
\item \textbf{1103}: success
\item \textbf{1210}: protocol (like "`tcp://"') not supported
\item \textbf{1211}: connection could not be established
\end{itemize}
% -----------------------------------------------------------------------------
\subsection{0020: Retrieve list of known peers}
Answers from ceof:
\begin{itemize}
\item \textbf{1120}: list follows
\begin{itemize}
\item four ASCII-digits containing number of peers ("`num\_peer"')
\item after that follow \textit{num\_peer} peer ids:
\begin{itemize}
\item 128 Byte containing the peer name (if shorter it is padded with 0-bytes), 0 terminated
\item 40 Byte containing the fingerprint of the
key\footnote{See RFC 2440, 11.2. Key IDs and Fingerprints}
\end{itemize}
\end{itemize}
\end{itemize}
% -----------------------------------------------------------------------------
\subsection{0021: Add peer}
Aftere the "`0021"' follow

\begin{itemize}
\item 128 bytes for the name of the peer
\item 128 bytes describing how to connect to the peer.
\item 40 bytes  containing the pgp-fingerprint of the key
\end{itemize}
Answers from ceof:
\begin{itemize}
\item \textbf{1121}: success, registered peer
\item \textbf{1220}: unknown peer
\item \textbf{1222}: peer name already used
\end{itemize}
% -----------------------------------------------------------------------------
\subsection{0022: Send message to peer}
Aftere the "`0022"' follow 128 bytes for the peer name
and after that 128 Bytes for the message.
Both 0-terminated, 0 padded.
Answers from ceof:
\begin{itemize}
\item \textbf{1122}: success
\item \textbf{1221}: unknown peer
\end{itemize}
% -----------------------------------------------------------------------------
\subsection{0023: Retrieve peer fingerprint}
Aftere the "`0023"' follows a 128 bytes fixed length string for the peer name.
Answers from ceof:
\begin{itemize}
\item \textbf{1123}: success
\begin{itemize}
\item follows 40 bytes fixed length string containing the fingerprint
\end{itemize}
\item \textbf{1221}: unknown peer
\end{itemize}
% -----------------------------------------------------------------------------
\subsection{0030: Get list of channels}
After the "`0030"' follow 128 Bytes containing the 
name of the peer.

Answers from ceof:

\begin{itemize}
\item \textbf{1130}: got list; following four ASCII-digits containing
number of channels ("`num\_chan"'); after that  num\_chan 128 Bytes packets
follow containing the channel name, padded with 0-bytes
\item \textbf{1230}: connection could not be established
\end{itemize}
% OK
% -----------------------------------------------------------------------------
\subsection{0031: Ask to join a channel via marktschreier}
After the "0031" follow

\begin{enumerate}
\item 128 Bytes containing the peer name
\item 128 Bytes describing the channel name.
\end{enumerate}

Answers from ceof:
\begin{itemize}
\item \textbf{1131}: success (means: markschreier asked known peers to
connect to us)
\item \textbf{1231}: connection could not be established
\item \textbf{1232}: access denied by markschreier: you are not allowed to join
\end{itemize}
% Ok
% -----------------------------------------------------------------------------
\subsection{0032: Send message to channel}
Aftere the "0032" follow 128 bytes for the channel name and after
that 128 Bytes for the message.
Answers from ceof:
\begin{itemize}
\item \textbf{1132}: success
\item \textbf{1233}: unknown channel
\end{itemize}
% -----------------------------------------------------------------------------
\subsection{0033: Create channel}
Aftere the "`0033"' follow 128 bytes containing the name of the channel.
\begin{itemize}
\item \textbf{1133}: success
\item \textbf{1234}: Channel already exists
\end{itemize}
% -----------------------------------------------------------------------------
\subsection{0034: Submit channel to marktschreier}
Aftere the "`0034"' follow 128 bytes containing the channel channel.
\begin{itemize}
\item \textbf{1134}: success
\item \textbf{1235}: Channel already exists
\end{itemize}
% -----------------------------------------------------------------------------
\subsection{1300: Recieved message}
After the "1300" follows:
\begin{itemize}
\item "`C"' for recieved in channel or "`P"' for recieved by a peer
\item 128 byte containing either the channel or the peer name
\item 128 byte containing either the channelname, if the first byte was a "`C"'
\item 128 Byte message
\end{itemize}
% -----------------------------------------------------------------------------
\subsection{1399: Exit notify}
ceof is being shutdown.
Shutdown yourself, too.
After that message ceof will exit and you should do the same.
No answer possible, ceof already decided to vanish.
% -----------------------------------------------------------------------------
\subsection{The way it works}
This section explains how the commands relate together and which commands to use
in which order.

% -----------------------------------------------------------------------------
\subsection{GUI initiated commands}
This section and all subsections are not yet finished. They
are in this draft to show the interested reader a preview of the
content of the next draft.
% -----------------------------------------------------------------------------
\subsubsection{GUI startup}
What todo, when the GUI starts.
Connect to ceof. Find out about
\begin{itemize}
\item joined channels,
\item connected marktscheier
\item and open queries.
\end{itemize}
It thus issues the following commands:
register, list joined channels, list open queries, list marktschreier.
% -----------------------------------------------------------------------------
\subsubsection{Creating a channel}
When you want to create a channel, you simply have to give it a name.
Ceof will use that name and sign it with your pgp key. The result is the
global unique channel identifier. For testing, you can build your channels
easily on the commandline:
\begin{verbatim}
% echo -n '!eof' > CHANNELNAME
% cat CHANNELNAME 124byteszero > CHANNELNAME.padded
% gpg -s CHANNELNAME 

You need a passphrase to unlock the secret key for
user: "Nico Schottelius (telmich) <nico-public@schottelius.org>"
1024-bit DSA key, ID 9885188C, created 2006-09-27

% ls -l CHANNELNAME*
-rw------- 1 nico nico   4 2007-09-17 21:32 CHANNELNAME
-rw------- 1 nico nico 128 2007-09-17 21:32 CHANNELNAME.padded
-rw------- 1 nico nico 113 2007-09-17 21:32 CHANNELNAME.padded.gpg

% gpg -d CHANNELNAME.padded.gpg 2>/dev/null
!eof
\end{verbatim}
% -----------------------------------------------------------------------------
\subsubsection{Finding a channel}
UNFINISHED
replace internal id with signature!

The GUI asks ceof, which channels are known. After that the GUI
can use the internal ID (which is "`unique"', as in: it is a 32 bit integer
that is increased as long as ceof is running) to join it.
% -----------------------------------------------------------------------------
\subsubsection{Joining a channel}
UNFINISHED
The channel must be known through 
% -----------------------------------------------------------------------------
\subsubsection{Leaving a channel}
UNFINISHED
Sends a message to all known participants that we leave the channel now.
% -----------------------------------------------------------------------------
\subsubsection{Invite to channel}
UNFINISHED
If you create a new channel, you may want to invite people to it.
% -----------------------------------------------------------------------------
\subsubsection{Listing friends}
% -----------------------------------------------------------------------------
\subsection{ceof initiated commands / messages}
UNFINISHED
% -----------------------------------------------------------------------------
\subsubsection{Recieved a join request}
UNFINISHED
Somebody wants to join in a channel, in which you are a member.
% -----------------------------------------------------------------------------
\subsubsection{Recieved a join notification request}
UNFINISHED
Somebody wants us to tell all members of the channel that she wants to join us.
% -----------------------------------------------------------------------------
\subsubsection{Recieved a channel message}
UNFINISHED
Must contain which channel, who send it and what is in the message.
% -----------------------------------------------------------------------------
\subsubsection{Recieved a private message}
UNFINISHED
This messages was send only to us, not to a channel.
%% -----------------------------------------------------------------------------
\chapter{Implementation}
Sample implementation for POSIX systems.
% -----------------------------------------------------------------------------
\section{Status}
Supported items of the current version are at least:
\begin{longtable}{|c|c|c|}
\caption{Implemented items in the sample implementation}\\
\hline
\textbf{Feature} & \textbf{Description} & \textbf{Since version/commit} \\
\hline
/quit & ui2user command & d372b38a2da99703066a1b9aa63cce9a84f72709\\
\hline
/peer add & ui2user command & 8dab67c01aa78d8b6ff0cea311d924d7215d187d\\
\hline
\end{longtable}

% -----------------------------------------------------------------------------
\chapter{Transport protocols}
% -----------------------------------------------------------------------------
\section{Introduction}
Only lower-case allowed (to prevent problems with broken filesystems).
% -----------------------------------------------------------------------------
\section{Examples}
This sections shows some theoretic (theoretic because nobody implemented
them yet) transport protocols.
% -----------------------------------------------------------------------------
\subsection{tcp}
% -----------------------------------------------------------------------------
\subsection{tcps}
% -----------------------------------------------------------------------------
\subsection{udp}
% -----------------------------------------------------------------------------
\subsection{http}
% -----------------------------------------------------------------------------
\subsection{https}
% -----------------------------------------------------------------------------
\subsection{smtp}
connect to smtp server
% -----------------------------------------------------------------------------
\subsection{smtps}
% -----------------------------------------------------------------------------
\subsection{mediawiki}
url, user, password
% -----------------------------------------------------------------------------
\subsection{smb}
write on windows shares
% -----------------------------------------------------------------------------
\subsection{mailto}
Write an email to some address. Needs smtp-server set in configuration.
May have different methods for retrieval (like connecting to imap,pop,
read from mbox/maildir directly).
% -----------------------------------------------------------------------------
\subsubsection{Example URLs}
\begin{verbatim}
mailto:nico-eof@eof.eof.name
\end{verbatim}
% -----------------------------------------------------------------------------
\subsection{dns}
Use dns traffic to transport EOF protocols.

% -----------------------------------------------------------------------------
\section{Embedding into EOF}
This section explains how to integrate a transport protocol into EOF.
% -----------------------------------------------------------------------------
\subsection{Adding a transport protocol}
If you want to add the transport protocol \emph{tptest}:
\begin{itemize}
\item Create the directories
\begin{itemize}
\item \textbf{\$HOME/.ceof/transport-protocols/available/\emph{tptest}}.
\end{itemize}
\item Create (link or copy) the executables to the filenames \textbf{listen}
and \textbf{send}.
\end{itemize}
The EOF implementation will register the transport protocol automatically
at the next start. You may register only the \textbf{listen} or
\textbf{send} part of a protocol.
% -----------------------------------------------------------------------------
\subsection{Using a transport protocol}
So far the EOF implementation knows about the implementation, and may also
already use it for \emph{sending} packets. But there is no listener configured
yet.
To enable a listener for the protocol \emph{tptest} at the URL
\emph{tptest:somewhere@protocol-specific}
\begin{itemize}
\item create a directory below
\begin{itemize}
\item \textbf{\$HOME/.ceof/transport-protocols/enabled/}
\end{itemize}
\item with a name of your choice (f.i. \emph{tptest-somwhere} or \emph{http-80}).
\item Then add the URL to the file named $<\textbf{url}>$.
\item If the transport protocol needs or allows additional configuration files,
you need to create them in that directory.
\end{itemize}
The EOF implementation will parse the URL and check whether a supporting
listener application is available.

Will do chdir() to the directory! tp can open config files in current dir.
what about url?

same for listen and send?
   listenurl, sendurl, config in curdir
Yes!

The maximum length of the URL is defined in ceofhack.h (EOF\_L\_ADDRESS).
If it is longer, it will be truncated after \textbf{EOF\_L\_ADDRESS} bytes.

IMPORTANT!
% -----------------------------------------------------------------------------
\section{Implementations}
The following sections cover existent protocol implementations.
The name of the section is the name of the registered implementation.
Every section must at least contain:
\begin{itemize}
\item Supported scheme
\item Author contact information
\item URL of website
\item Programming language
\item EOF-Version that introduces support for the protocol
\end{itemize}
You should add your implementation to the directory "`tp"' within the
repository.
Sort sections by alphabet.

% FIXME: maybe create a longtable containing all protocols
% FIXME: only add further information to subsections
% -----------------------------------------------------------------------------
\subsection{dummy/c}
\begin{itemize}
\item dummy
\item Nico Schottelius [nico-eof-tp-dummy-c =at= schottelius.org]
\item https://www.eof.name
\item C
\item Version: 1
\end{itemize}
% -----------------------------------------------------------------------------
\subsection{tcp-apic}
\begin{itemize}
\item tcp
\item A. Pic
\item ?
\item C
\item Version: 1
\end{itemize}


% -----------------------------------------------------------------------------
\chapter{pmg2ceof import}

2007-12-03 v0.1.3-bed / adi, telmich

\section{Introduction}
This document specifies the commands send from \textbf{pmg} to and from
\textbf{ceof}\footnote{the central EOF-1 application} to the \textbf{pmg}.

\subsection{Changelog}
% -----------------------------------------------------------------------------
\subsubsection{v0.1.2 to v0.1.3}
\begin{itemize}
\item Added name of peer to "`\textbf{1304}"', "`\textbf{1305}"' and "`\textbf{1306}"'
\item Changed protocol version to "`03"'
\end{itemize}
% -----------------------------------------------------------------------------
\subsubsection{v0.1.1 to v0.1.2}
\begin{itemize}
\item "`\textbf{1300}"' expanded: Now also passing the fingerprint
\item "`\textbf{1303}"' expanded: Return the next address
\item Added commands "`\textbf{1304}"' to "`\textbf{1307}"'
\item Changed protocol version to "`02"'
\end{itemize}
% -----------------------------------------------------------------------------
\subsubsection{v0.1 to v0.1.1}
\begin{itemize}
\item Removed support for "`\textbf{0001}"'
\begin{itemize}
\item No need to deregister on crash, \textbf{ceof} will restart you anyway.
\end{itemize}
\item Changed protocol version to "`01"'
\end{itemize}
% -----------------------------------------------------------------------------
\subsubsection{v0.1}
\begin{itemize}
\item Initial release
\end{itemize}
% -----------------------------------------------------------------------------
\section{Commands}
All commands are send as 4-Byte ASCII digits (for instance "`0012"').
There is no transfer of binary numbers between \textbf{ceof} and \textbf{pmg}.
All answers and all numbers are ASCII-numbers. We
\textbf{pmg commands} always begin with \textbf{0} ("`0042"' for instance),
\textbf{answers} or \textbf{notifications} from
\textbf{ceof} begin with \textbf{1} ("`1023"' for instance).
After each command follows individual data. The second byte indicates the type of message:
\begin{itemize}
\item \textbf{0}: \textbf{pmg} messages
\begin{itemize}
\item \textbf{00}: \textbf{pmg} (de-)initialisation
\item \textbf{01}: \textbf{pmg} success messages
\item \textbf{02}: \textbf{pmg} error messages
\end{itemize}
\item \textbf{1}: \textbf{ceof} messages
\begin{itemize}
\item \textbf{10}: \textbf{ceof} (de-)initialisation
\item \textbf{11}: \textbf{ceof} success messages
\item \textbf{12}: \textbf{ceof} error messages
\item \textbf{13}: \textbf{ceof} peer messages
\end{itemize}
\end{itemize}

% -----------------------------------------------------------------------------
\subsection{Pmg commands}
% -----------------------------------------------------------------------------
\subsubsection{0000: Register pmg}
After the "`0000"' \textbf{pmg} directly appends two ASCII digits containing the
version of the client to ceof protocol it speaks. This specification
uses version "`\textbf{03}"'.
Answers from ceof:
\begin{itemize}
\item \textbf{1100}: success, you are connected
\item \textbf{1200}: version not supported
\end{itemize}
% -----------------------------------------------------------------------------
\subsection{Ceof commands}
% -----------------------------------------------------------------------------
\subsubsection{1099: Exit}
Answers from \textbf{pmg}:
\begin{itemize}
\item \textbf{0199}: Exiting
\item \textbf{0223}: strange error (results in being killed -9)
\end{itemize}
% -----------------------------------------------------------------------------
\subsubsection{1300: Add peer}
After the \textbf{1300} follows
\begin{itemize}
\item a 128 byte "`fixed length string"' containing the peer name
\item a 128 byte "`fixed length string"' containing the peer address
\item a 40 byte  "`fixed length string"' containing the peer fingerprint
\end{itemize}
Answers from \textbf{pmg}:
\begin{itemize}
\item \textbf{0100}: peer added
\item \textbf{0223}: strange error
\end{itemize}
% -----------------------------------------------------------------------------
\subsubsection{1301: Get peer fingerprint}
After the \textbf{1301} follows
\begin{itemize}
\item 128 byte "`fixed length string"' containing the name of the peer
\end{itemize}
Answers from \textbf{pmg}:
\begin{itemize}
\item \textbf{0100}: success: fingerprint follows
\begin{itemize}
\item 40 byte "`fixed length string"' containing the fingerprint
\end{itemize}
\item \textbf{0200}: unknown peer
\item \textbf{0223}: strange error
\end{itemize}
% -----------------------------------------------------------------------------
\subsubsection{1302: Rename peer}
After the \textbf{1302} follows
\begin{itemize}
\item 128 byte "`fixed length string"' containing the old name of the peer
\item 128 byte "`fixed length string"' containing the new name of the peer
\end{itemize}
Answers from \textbf{pmg}:
\begin{itemize}
\item \textbf{0101}: success
\item \textbf{0223}: strange error
\end{itemize}
% -----------------------------------------------------------------------------
\subsubsection{1303: Get address of peer}
After the \textbf{1303} follows
\begin{itemize}
\item 128 byte "`fixed length string"' containing the name of the peer
\end{itemize}
Answers from \textbf{pmg}:
\begin{itemize}
\item \textbf{0102}: success
\begin{itemize}
\item 128 byte "`fixed length string"' containing the address
\end{itemize}
\item \textbf{0200}: unknown peer
\item \textbf{0223}: strange error
\end{itemize}
\textbf{Pmg} MUST keep state of the last sent address.
\textbf{Pmg} MUST return the next address it knows of the peer.
If there is only one address, it is the next address.
% -----------------------------------------------------------------------------
\subsubsection{1304: Add address to peer}
After the \textbf{1304} follows
\begin{itemize}
\item 128 byte "`fixed length string"' containing the name of the peer
\item 128 byte "`fixed length string"' containing an address to add
\end{itemize}
Answers from \textbf{pmg}:
\begin{itemize}
\item \textbf{0104}: success
\item \textbf{0223}: strange error
\end{itemize}
% -----------------------------------------------------------------------------
\subsubsection{1305: Remove address from peer}
After the command follows
\begin{itemize}
\item 128 byte "`fixed length string"' containing the name of the peer
\item 128 byte "`fixed length string"' containing the address to remove
\end{itemize}
Answers from \textbf{pmg}:
\begin{itemize}
\item \textbf{0105}: success
\item \textbf{0205}: Cannot remove, because it is the last known address
\item \textbf{0223}: strange error
\end{itemize}
% -----------------------------------------------------------------------------
\subsubsection{1306: Update peer fingerprint}
After the command follows
\begin{itemize}
\item 128 byte "`fixed length string"' containing the name of the peer
\item 40  byte "`fixed length string"' containing the new peer fingerprint
\end{itemize}
Answers from \textbf{pmg}:
\begin{itemize}
\item \textbf{0106}: success
\item \textbf{0223}: strange error
\end{itemize}
% -----------------------------------------------------------------------------
\subsubsection{1307: Remove peer}
After the \textbf{1307} follows
\begin{itemize}
\item 128 byte "`fixed length string"' containing the name of the peer
\end{itemize}
Answers from \textbf{pmg}:
\begin{itemize}
\item \textbf{0107}: success, peer removed
\item \textbf{0200}: unknown peer
\item \textbf{0223}: strange error
\end{itemize}
% -----------------------------------------------------------------------------
\chapter{politiker2ceof import}

2007-11-12 v0.1-train / telmich

\section{Introduction}
This document specifies the commands send from politiker to and from
ceof\footnote{the central EOF-1 application} to the politiker.

\subsection{Changelog}
\subsubsection{none}
\begin{itemize}
\item -
\end{itemize}
% -----------------------------------------------------------------------------
\section{Connection}
The politiker is started by ceof at startup and communicates through stdin
and stdout.
% -----------------------------------------------------------------------------
\section{Commands}
All commands are send as uint32\_t types.
\textbf{Politiker commands} always begin with
\textbf{3} ("`3042"' for instance),
\textbf{answers} or \textbf{notifications} from
ceof begin with \textbf{1} ("`1023"' for instance).
After each command follows individual data. The second byte indicates the type of message:
\begin{itemize}
\item \textbf{30}: politiker messages
\begin{itemize}
\item \textbf{300}: (De-)Initialisation
\item \textbf{301}: Peer related messages
\item \textbf{302}: Message related messages
\end{itemize}
\item \textbf{10}: ceof messages
\begin{itemize}
\item \textbf{100}: (De-)Initialisation
\item \textbf{101}: Peer related messages
\item \textbf{102}: Message related messages
\item \textbf{103}: Message related answers
\end{itemize}
\end{itemize}

% -----------------------------------------------------------------------------
\subsection{30: Politiker messages}
% -----------------------------------------------------------------------------
\subsection{3000: Register politker}
After the "`3000"' the politker directly appends an
\textit{uint32\_t} containing the version of the politker to ceof protocol
it speaks. This specification uses version number "`0"'.
Answers from ceof:
\begin{itemize}
\item \textbf{1100}: sucess, you are connected
\item \textbf{1200}: version not supported
\end{itemize}
% -----------------------------------------------------------------------------
\subsection{3001: Deregister politiker}
The politker has some problem and has to exit. Ceof will restart a new
instance of it.
Answers from ceof:
\begin{itemize}
\item none
\end{itemize}
% -----------------------------------------------------------------------------
\subsection{3010: Retrieve random peer address and fingerprint}
The politker needs some peer information to be used as a hop.
Ceof forwards that request to \textbf{pmg}\footnote{peer manager} and returns
the answer to the politiker.
Answers from ceof:
\begin{itemize}
\item 1010: Data follows
\begin{itemize}
\item \textit{peer\_address}: 128 Bytes, 0 padded, 0 terminated
\item \textit{peer\_fingerprint}: 40 Bytes char array
\end{itemize}
\end{itemize}
% -----------------------------------------------------------------------------
\subsection{3011: Retrieve number of available peers}
The politker needs to know how much "`unique"' peers are available,
so it can match the required minimum.
Ceof forwards that request to \textbf{pmg} and returns the answer to the
politiker.
Answers from ceof:
\begin{itemize}
\item 1010: Data follows
\begin{itemize}
\item \textit{number\_of\_peers}: uint32\_t
\end{itemize}
\end{itemize}
% -----------------------------------------------------------------------------
\subsection{3020: Created an encrypted packet}
Passes the following information to ceof:
\begin{itemize}
\item The length of the packet (uint32\_t) (\textit{pck\_len})
\item The packet (\textit{pck})
\end{itemize}

After the \textbf{politiker} send \textit{pck\_len},
\textbf{ceof} must respond with either
\begin{itemize}
\item \textbf{1030}: pagket length is accepted
\item \textbf{1031}: pagket length is too long
\end{itemize}

If the response is \textit{1030}, \textbf{politiker} should send the
pcaket, otherwise this session is finished and \textbf{politiker}
should drop the packet.
% -----------------------------------------------------------------------------
\subsection{10: Ceof messages}
% -----------------------------------------------------------------------------
\subsection{1020: Create encrypted packet}
Passes the following information to the politiker:
\begin{itemize}
\item GPG-Fingerprint of the peer (40 Bytes char array) (\textit{fpr})
\item Adress of the peer (128 Bytes, 0 padded, 0 terminated) (\textit{address})
\item The length of the message (uint32\_t) (\textit{msg\_len})
\item The message (\textit{msg})
\end{itemize}

After \textbf{ceof} send \textit{msg\_len}, politiker must respond with
either
\begin{itemize}
\item \textbf{3020}: message length is accepted
\item \textbf{3021}: message length is too long
\end{itemize}

If the response is \textit{3020}, \textbf{ceof} should send the messsage,
otherwise this session is finished and the next thing the politiker expects
is a command.

% -----------------------------------------------------------------------------
\chapter{Unsorted}
\section{Channels}
Exist as long as somebody remembers it
Channel name is signed by creator?
% -----------------------------------------------------------------------------
\appendix
\chapter{Sources}
\begin{thebibliography}{42}
\bibitem{pgp-1} http://en.wikipedia.org/wiki/Public-key\_cryptography
\bibitem{onion-1} http://en.wikipedia.org/wiki/Onion\_routing
\bibitem{tor-1} https://wiki.torproject.org/noreply/TheOnionRouter
\bibitem{irc-1} RFC 1459: http://www.irchelp.org/irchelp/rfc/rfc.html
\bibitem{source-routing-1} http://en.wikipedia.org/wiki/Source\_routing
\bibitem{tcp-1} RFC 793: http://www.faqs.org/rfcs/rfc793.html
\bibitem{http-1} RFC 2616: http://www.faqs.org/rfcs/rfc2616.html
\bibitem{smtp-1} RFC 2821: http://www.faqs.org/rfcs/rfc2821.html
\bibitem{avian-1} RFC 1149: http://www.faqs.org/rfcs/rfc1149.html
\bibitem{uri-1} RFC 3986: http://www.faqs.org/rfcs/rfc3986.html
\bibitem{!eof} https://www.eof.name
\end{thebibliography}

\printindex
\end{document}
