\documentclass[12pt,a4paper]{book}
\usepackage[latin1]{inputenc}    % Ascii-Format dieses Dokuments
\usepackage{longtable}           % lange Tabellen

\begin{document}
\title{EOF\\Eris Onion Forwarding\\
The secure, peer-to-peer, decentralised anonymous chat network}
\date{2009-03-12}
\author{Nico -telmich- Schottelius}

\maketitle
\tableofcontents
\newpage

% -----------------------------------------------------------------------------
\chapter{Introduction}
% -----------------------------------------------------------------------------
\section{Abstract}
EOF is chat protocol that supports secure chatting.
Secure chatting consists of the following features:
\begin{enumerate}
\item Nobody, but the intended receiver(s) know \emph{that} you wrote a message.
\item Nobody, but the intended receiver(s) can view the \emph{message content}.
\item Nobody, but the intended receiver(s) can \emph{verify} the source of the message being you.
\item Nobody, but the intended receiver(s) know \emph{who} you sent a message to.
\end{enumerate}
We don't think it's possible to hide that you are part of the chat network.
Thus, every participant of an EOF network will constantly send packets
(so called \emph{noise}) in a defined frequency (for instance every 250 ms).
The noise is also used to defend against timing analysis.
In case you are sending out a message, the message packet will be added to the
queue and sent with the next free interval.

We encrypt and sign every message via public-key cryptography\cite{pgp-1},
so that only the receiver can decrypt, view the message content and verify
the message sender.

The message packets are always send indirectly via onion routing\cite{onion-1}.
The idea is taken from the Tor project\cite{tor-1}, though EOF uses an enhanced
version: EOF does not know about entry or exit nodes. If you are the intended
receiver you may or may not continue to forward the message, which is defined
by the sender of the message. That said, EOF must use source
routing\cite{source-routing-1}.

EOF knows about two different chat destinations:
\begin{enumerate}
\item Peers
\item Groups of peers
\end{enumerate}
A peer is just another person (direct chat), a group of peers is the EOF
equivalent of the IRC channel\cite{irc-1}. As there is no central server,
groups of peers are managed by each client and may thus by differnt by
different peers.

EOF does not implement nor specify \emph{transport protocols} itself.
The EOF community is urged to implement them in a creative way: Usage
of well-known protocols like TCP\cite{tcp-1}, HTTP\cite{http-1},
SMTP\cite{smtp-1} or even transmission of packets on avian
carriers\cite{avian-1} are encouraged. The tunneling of EOF packets into
those protocols (also know as obfuscation) makes it harder to detect
and block EOF traffic.
% -----------------------------------------------------------------------------
\section{Motivation}
Must have been written somewhere else already
% -----------------------------------------------------------------------------
\section{Copying, authors, ...}
% -----------------------------------------------------------------------------
\section{Further directions}
Analyse security
enhance performance
port to other systems
spread the word
% -----------------------------------------------------------------------------
\section{Conventions}
\$NAME = variable
% -----------------------------------------------------------------------------
\section{Introduction}
missing :-)
and further sections, too. Currently just documentating, what is important
for now.
% -----------------------------------------------------------------------------
\chapter{The EOF protocol}
% -----------------------------------------------------------------------------
\section{Version}
This will be version \textbf{1} of the protocol. It is the first definition.
Further changes will be documentated in this section.
% -----------------------------------------------------------------------------
\section{Introduction}
Stateless: source routing, usage of acks.
% -----------------------------------------------------------------------------
\section{Onion-Packets}
What's seen from outside
% -----------------------------------------------------------------------------
\section{Packets}
What's seen from inside (after stripping of the onion skin).
% -----------------------------------------------------------------------------
\section{Data types}
% -----------------------------------------------------------------------------
\subsection{Commands}
Commands are 4 Byte ASCII numbers.
% -----------------------------------------------------------------------------
\section{Interface description}
General: pipe'd:
Data from the EOF implementation is received on stdin 

The command is always the first part of a message.

THE FOLLOWING DATA IS AN IMPORT FROM BASICS.TEX

EOF-1\\Basic definitions
2007-11-22 v0.2-train
% -----------------------------------------------------------------------------
\subsection{Command fields}
The command field 0 indicates the direction.
\begin{longtable}{|c|c|}
\caption{Command field 0}\\
\hline
\textbf{Value} & \textbf{Description}\\
\hline
1 & Message is coming from EOF implementation\\
\hline
2 & Message is coming from EOF subsystem (internally)\\
\hline
3 & Message is coming from outside (received packet))\\
\hline
\end{longtable}

The command field 1 indicates the EOF subsystem.
\begin{longtable}{|c|c|}
\caption{Command field 1}\\
\hline
\textbf{Value} & \textbf{Description}\\
\hline
0 & \textbf{eofi2tp}: Transport protocols\\
\hline
1 & \textfbf{eofi2ui}: User interface\\
\hline
\end{longtable}

The command fields 2 and 3 are defined by the respective subsystem.
% -----------------------------------------------------------------------------
\subsection{Introduction}
This document specifies the basic datatypes and connection
methods used in EOF-1. The aim is to stop repeatition of
datatype definition in other documents.

\subsection{Changelog}
% -----------------------------------------------------------------------------
\subsubsection{v0.1 to v0.2}
\begin{itemize}
\item Add versions specification
\end{itemize}
% -----------------------------------------------------------------------------
\subsubsection{v0.1}
\begin{itemize}
\item Initial release
\end{itemize}
% -----------------------------------------------------------------------------
\subsection{Versions}
This section clearifies the use of versions in the programs and protocols.
% -----------------------------------------------------------------------------
\subsubsection{Protocol}
The version of a protocol consists of 
\begin{itemize}
\item \textbf{major} number,
\item \textbf{minor} number and
\item the \textbf{patchlevel}
\end{itemize}
An increment of either number must be reflected with a protocol version change
within the protocol definition.
% -----------------------------------------------------------------------------
\subsection{Major number}
Within one major number the same aim should be followed. For instance
version "`0.x.y"' could target the first release.
% -----------------------------------------------------------------------------
\subsection{Minor number}
Within one minor number the same functionality should be kept.
For instance "`0.1.y"' contains basic functionality, "`0.2.y"' could
contain complete new functionality.
% -----------------------------------------------------------------------------
\subsection{Patchlevel}
The patchlevels are used to correct mistakes, but do not change the API.
% -----------------------------------------------------------------------------
\subsection{Valid from...}
All protocol definitions (includings drafts) that are released after
\textbf{20071122} should follow this version numbering scheme.
% -----------------------------------------------------------------------------
\subsection{Programs}
% -----------------------------------------------------------------------------
\subsection{Connections}
\subsection{Sockets}
Sockets are named Unix sockets.
\subsection{Stdin  and stdout}
To make programming easier, communication between some parts in EOF-1 is realised
using stdin and stdout. 
% -----------------------------------------------------------------------------
\subsection{Environment}
Environment variable are set from the operating system or from the user.
The following environment variables are used with EOF-1:
% -----------------------------------------------------------------------------
\subsection{HOME}
Home directory of the user.
% -----------------------------------------------------------------------------
\subsection{CEOF\_DIR}
Ceof configuration directory.
% -----------------------------------------------------------------------------
\subsection{CEOF\_CLIENT\_SOCKET}
The socket that the clients (GUIs) should use.
Relative to the directory specified by CEOF\_DIR.
% -----------------------------------------------------------------------------
\subsection{Paths}
% -----------------------------------------------------------------------------
\subsection{Ceof configuration directory}
% -----------------------------------------------------------------------------
\subsubsection{Default case}
Normally, \$HOME is set and \$CEOF\_DIR is not set. In that case
the configuration directory defaults to \textit{\$HOME/.ceof}.
% -----------------------------------------------------------------------------
\subsubsection{HOME is unset}
If the environment variable "`\textit{HOME}`" is not set,
the directory named \textit{.ceof} in the current directory will be used.
% -----------------------------------------------------------------------------
\subsubsection{CEOF\_DIR is set}
If the environment variable "`\textit{CEOF\_DIR}`" is set,
its content will be used to refer to the configuration directory.
% -----------------------------------------------------------------------------
\subsection{Ceof client socket}
The client connects to a socket named \textit{clients/socket}, relative
to the configuration directory.
% -----------------------------------------------------------------------------
\subsubsection{CEOF\_CLIENT\_SOCKET is set}
If the environment variable \textit{CEOF\_CLIENT\_SOCKET} is set,
"`\textit{clients/socket}"` should be replaced by its content.
% -----------------------------------------------------------------------------
\subsection{Datatypes and dataspecification}
% -----------------------------------------------------------------------------
\subsection{Basic data types}
% -----------------------------------------------------------------------------
\subsubsection{Binary numbers}
Between some parts of EOF-1 are binary numbers (as in \textit{uint32\t})
exchanged. -- IS THIS TRUE?
% -----------------------------------------------------------------------------
\subsubsection{The zero Byte}
The zero Byte is a Byte with the value 0.
% -----------------------------------------------------------------------------
\subsubsection{Strings in general}
Strings are transmitted without termination (i.e. no new line, no 0 byte).
% -----------------------------------------------------------------------------
\subsubsection{ASCII numbers}
ASCII numbers use the string representation of a number.
% -----------------------------------------------------------------------------
\subsubsection{Variable length strings}
Before variable length strings the length is submitted in a fixed size
datatype.
% -----------------------------------------------------------------------------
\subsubsection{Fixed length strings}
Fixed length strings contain exactly the specified number of Bytes:
In a 128 Byte fixed length string fits at most 128 Bytes of text,
which is then not zero terminated!
If the text it contains is shorter than the specified length,
it must be padded with zero Bytes (see above).
% -----------------------------------------------------------------------------
\subsubsection{Padding data}
Should be random data.
% -----------------------------------------------------------------------------
\subsection{EOF simple data types}
The following sections define the datatypes used in EOF related
applications. The recommened name for use in source
code is added in parentheses after the human understandable name.
% -----------------------------------------------------------------------------
\subsubsection{Peer name (peername)}
The peer name is a 128 Byte fixed length string. It is only
used internally to give a peer a rememberisable name ("`a nick'").
It is never transmitted over the network.
% -----------------------------------------------------------------------------
\subsubsection{Channel name (channel)}
The channel name is a 128 Byte fixed length string.
% -----------------------------------------------------------------------------
\subsubsection{Message text (msgtext)}
The message text is a 128 Byte fixed length string.
% -----------------------------------------------------------------------------
\subsubsection{Peer fingerprint (pfpr)}
The peer fingerprint is a 40 Byte fixed length string.
% -----------------------------------------------------------------------------
\subsection{EOF packet data types}
All packets must be signed by the sender and encrypted for the reciever.
The different datatypes are just concatenated in the order
described.
An EOF packet always contains 512 Bytes.
% -----------------------------------------------------------------------------
\subsubsection{Message packet}
\begin{itemize}
\item Command type "`8000"'
\item Channel name
\item Message text
\end{itemize}
% -----------------------------------------------------------------------------
\subsubsection{Retrieve peer address}
\begin{itemize}
\item Command type "`8001"'
\item Peer fingerprint
\item Padding
\end{itemize}
% -----------------------------------------------------------------------------
\subsubsection{Submit peer address}
\begin{itemize}
\item Command type "`8002"'
\item Peer fingerprint
\item Peer address
\item Padding
\end{itemize}
% -----------------------------------------------------------------------------
\subsubsection{Forward packet}
\begin{itemize}
\item Command type "`8003"'
\item Peer fingerprint
\item Peer address
\item Padding
\end{itemize}
% -----------------------------------------------------------------------------
\subsection{EOF network data types}
These datatypes are transmitted over the network and are only
encapsulated by the specific network protocol.
% -----------------------------------------------------------------------------
\subsection{General network packet}
\begin{itemize}
\item Type of packet
\item Next receiver: Peer address
\item Message text
\end{itemize}
% -----------------------------------------------------------------------------

THE DATA BEFORE IS AN IMPORT FROM BASICS.TEX

% -----------------------------------------------------------------------------
\section{Transport protocols ("`eofi2tp"')}
Environment variables: CWD for listener
URLs are used as defined in RFC3986\cite{uri-1}.
Transport protocols use EOF command ID 0.

\subsection{1000: Send packet}
\begin{longtable}{|c|c|c|c|}
\caption{Command 1000 parameters}\\
\hline
\textbf{Parameter} & \textbf{Type} & \textbf{Description} & \textbf{Example}\\
\hline
Size & ASCII Number + \textbackslash{}n & Size of message, excluding this header & 424242\\
\hline
Message & Binary data & The message & BLOB\\
\hline
Destination & URL without scheme & The \emph{proto:} part is stripped of & 127.0.0.3:42\\
\hline
\end{longtable}

\subsection{2000: Send packet}


% -----------------------------------------------------------------------------
\section{The user interface (UI)}
Maybe own section.
List and describe commands.
Command = subsection
% -----------------------------------------------------------------------------
\section{Configuration}
cconfig

% -----------------------------------------------------------------------------
\chapter{Implementation}
Sample implementation for POSIX.

% -----------------------------------------------------------------------------
\chapter{Transport protocols}
% -----------------------------------------------------------------------------
\section{Introduction}
Only lower-case allowed (to prevent problems with broken filesystems).
% -----------------------------------------------------------------------------
\section{Examples}
This sections shows some theoretic (theoretic because nobody implemented
them yet) transport protocols.
% -----------------------------------------------------------------------------
\subsection{tcp}
% -----------------------------------------------------------------------------
\subsection{tcps}
% -----------------------------------------------------------------------------
\subsection{udp}
% -----------------------------------------------------------------------------
\subsection{http}
% -----------------------------------------------------------------------------
\subsection{https}
% -----------------------------------------------------------------------------
\subsection{smtp}
connect to smtp server
% -----------------------------------------------------------------------------
\subsection{smtps}
% -----------------------------------------------------------------------------
\subsection{mediawiki}
url, user, password
% -----------------------------------------------------------------------------
\subsection{smb}
write on windows shares
% -----------------------------------------------------------------------------
\subsection{email}
Write an email to some address. Needs smtp-server set in configuration.
% -----------------------------------------------------------------------------
\subsection{dns}
Use dns traffic to transport EOF protocols.

% -----------------------------------------------------------------------------
\section{Embedding into EOF}
This section explains how to integrate a transport protocol into EOF.
% -----------------------------------------------------------------------------
\subsection{Adding a transport protocol}
If you want to add the transport protocol \emph{tptest}:
\begin{itemize}
\item Create the directories
\begin{itemize}
\item \textbf{\$HOME/.ceof/transport-protocols/available/\emph{tptest}}.
\end{itemize}
\item Create (link or copy) the executables to the filenames \textbf{listen}
and \textbf{send}.
\end{itemize}
The EOF implementation will register the transport protocol automatically
at the next start. You may register only the \textbf{listen} or
\textbf{send} part of a protocol.
% -----------------------------------------------------------------------------
\subsection{Using a transport protocol}
So far the EOF implementation knows about the implementation, may also already
use for \emph{sending} packets. But there is no listener configured yet.
To enable a listener for the protocol \emph{tptest} at the URL
\emph{tptest:somewhere@protocol-specific}
\begin{itemize}
\item create a directory below
\begin{itemize}
\item \textbf{\$HOME/.ceof/transport-protocols/enabled/}
\end{itemize}
\item with a name of your choice (f.i. \emph{tptest-somwhere} or \emph{http-80}).
\item Then add the URL to the file named $<\textbf{url}>$.
\item If the transport protocol needs or allows additional configuration files,
you need to create them in that directory.
\end{itemize}
The EOF implementation will parse the URL and check whether a supporting
listener application is available.
% -----------------------------------------------------------------------------
\section{Implementations}
The following sections cover existent protocol implementations.
The name of the section is the name of the registered implementation.
Every section must at least contain:
\begin{itemize}
\item Author contact information
\item URL of website
\item EOF-Version that introduces support for the protocol
\end{itemize}

If there are multiple implementations available, create two subsections
covering both implementations.
% -----------------------------------------------------------------------------
\chapter{Unsorted}
\section{Channels}
Exist as long as somebody remembers it
Channelname is signed by creator?
% -----------------------------------------------------------------------------
\appendix
\chapter{Sources}
\begin{thebibliography}{42}
\bibitem{pgp-1} http://en.wikipedia.org/wiki/Public-key\_cryptography
\bibitem{onion-1} http://en.wikipedia.org/wiki/Onion\_routing
\bibitem{tor-1} https://wiki.torproject.org/noreply/TheOnionRouter
\bibitem{irc-1} RFC 1459: http://www.irchelp.org/irchelp/rfc/rfc.html
\bibitem{source-routing-1} http://en.wikipedia.org/wiki/Source\_routing
\bibitem{tcp-1} RFC 793: http://www.faqs.org/rfcs/rfc793.html
\bibitem{http-1} RFC 2616: http://www.faqs.org/rfcs/rfc2616.html
\bibitem{smtp-1} RFC 2821: http://www.faqs.org/rfcs/rfc2821.html
\bibitem{avian-1} RFC 1149: http://www.faqs.org/rfcs/rfc1149.html
\bibitem{uri-1} RFC 3986: http://www.faqs.org/rfcs/rfc3986.html
\end{thebibliography}
\end{document}
